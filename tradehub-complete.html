<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finaura Pro - Ultimate Trading Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }

        /* Top Navigation */
        .top-nav {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 20px 0;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
            white-space: nowrap;
        }

        .nav-links {
            display: flex;
            gap: 5px;
            flex: 1;
        }

        .nav-link {
            padding: 20px 16px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
        }

        .nav-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 250px;
            padding: 8px 35px 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--accent-blue);
            transform: rotate(180deg);
        }

        /* Account Summary Bar */
        .account-bar {
            background: var(--bg-secondary);
            padding: 12px 20px;
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 10px;
        }

        .account-item {
            text-align: center;
        }

        .account-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 2px;
            text-transform: uppercase;
        }

        .account-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* Main Layout */
        .main-container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 20px;
        }

        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .sidebar, .right-panel {
                display: none;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .sidebar h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }

        .watchlist-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .watchlist-item:hover {
            background: var(--accent-blue);
            transform: translateX(5px);
        }

        .market-scanner {
            margin-top: 20px;
        }

        .scanner-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .scanner-tab {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .scanner-tab.active {
            background: var(--accent-green);
            color: white;
        }

        /* Main Content */
        .main-content {
            min-height: 80vh;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Styles */
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stock-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .stock-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-color: var(--accent-blue);
        }

        /* Chart Section */
        .chart-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .timeframe-buttons, .chart-type-buttons, .indicator-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        .btn.active {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
            border: none;
        }

        /* Chart Canvas */
        .chart-container {
            width: 100%;
            height: 500px;
            position: relative;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 10px;
        }

        .chart-container canvas {
            width: 100%;
            height: 100%;
        }

        /* Portfolio Analytics */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .metric-subtext {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Pie Chart for Diversification */
        .pie-chart-container {
            width: 100%;
            max-width: 400px;
            height: 400px;
            margin: 0 auto;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        tr {
            transition: all 0.3s;
            cursor: pointer;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .news-feed {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            max-height: 600px;
            overflow-y: auto;
        }

        .news-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .news-item:hover {
            background: var(--accent-blue);
        }

        .news-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .news-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Alerts Panel */
        .alerts-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .alert-item {
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-blue);
        }

        .alert-item.executed {
            border-left-color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close-modal:hover {
            color: var(--accent-red);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            animation: slideInRight 0.4s ease;
            display: none;
            max-width: 350px;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.show {
            display: block;
        }

        .notification.error {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--accent-blue), #2563eb);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover, .tab.active {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            transition: width 0.3s;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Comparison Tool */
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .comparison-card {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        /* Heat Map */
        .heat-map {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .heat-map-cell {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .heat-map-cell:hover {
            transform: scale(1.05);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .search-box input {
                width: 150px;
            }

            .account-bar {
                font-size: 0.8rem;
            }

            .chart-container {
                height: 300px;
            }
        }

        /* Custom Scrollbar for News Feed */
        .news-feed::-webkit-scrollbar {
            width: 6px;
        }

        /* Achievement Badges */
        .achievements {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .achievement-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .achievement-badge:hover {
            transform: scale(1.1) rotate(10deg);
        }

        .achievement-badge.locked {
            background: var(--bg-tertiary);
            opacity: 0.5;
        }

        /* Goals Section */
        .goal-card {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .goal-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        /* Stock Detail View */
        .stock-detail-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 999;
            overflow-y: auto;
            padding: 20px;
        }

        .stock-detail-overlay.active {
            display: block;
        }

        .stock-detail-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border-color);
        }

        .detail-close-btn {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--accent-red);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }

        .detail-close-btn:hover {
            background: #dc2626;
            transform: rotate(90deg);
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .detail-title h1 {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        .detail-subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .detail-price-box {
            text-align: right;
        }

        .detail-price {
            font-size: 3rem;
            font-weight: bold;
        }

        .detail-change {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .time-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .time-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .time-btn.active {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        .time-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        .detail-chart-container {
            background: var(--bg-tertiary);
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
            height: 450px;
            position: relative;
        }

        .detail-chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .metrics-grid-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .metric-card-detail {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .metric-card-detail:hover {
            transform: translateY(-3px);
            border-color: var(--accent-green);
        }

        .metric-label-detail {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .metric-value-detail {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .trade-buttons-detail {
            display: flex;
            gap: 15px;
            margin: 30px 0;
        }

        .trade-btn-detail {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .buy-btn-detail {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
        }

        .buy-btn-detail:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .sell-btn-detail {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
        }

        .sell-btn-detail:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }

        @media (max-width: 768px) {
            .stock-detail-container {
                padding: 20px;
            }
            
            .detail-title h1 {
                font-size: 1.8rem;
            }
            
            .detail-price {
                font-size: 2rem;
            }
            
            .detail-chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Stock Detail Overlay -->
    <div id="stockDetailOverlay" class="stock-detail-overlay">
        <button class="detail-close-btn" onclick="closeStockDetail()">√ó</button>
        <div class="stock-detail-container" id="stockDetailContent">
            <!-- Content will be dynamically generated -->
        </div>
    </div>

    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="nav-container">
            <div class="logo" onclick="switchPage('dashboard')">üöÄ Finaura Pro Ultimate</div>
            <div class="nav-links">
                <div class="nav-link active" onclick="switchPage('dashboard')">Dashboard</div>
                <div class="nav-link" onclick="switchPage('portfolio')">Portfolio</div>
                <div class="nav-link" onclick="switchPage('analytics')">Analytics</div>
                <div class="nav-link" onclick="switchPage('history')">History</div>
                <div class="nav-link" onclick="switchPage('watchlist')">Watchlist</div>
                <div class="nav-link" onclick="switchPage('scanner')">Scanner</div>
                <div class="nav-link" onclick="switchPage('limit-orders')">Limit Orders</div>
                <div class="nav-link" onclick="switchPage('comparison')">Compare</div>
                <div class="nav-link" onclick="switchPage('goals')">Goals</div>
                <div class="nav-link" onclick="switchPage('education')">Learn</div>
            </div>
            <div class="nav-controls">
                <div class="search-box">
                    <input type="text" placeholder="Search stocks..." id="searchInput" oninput="searchStocks()">
                </div>
                <div class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</div>
            </div>
        </div>
    </div>

    <!-- Account Summary Bar -->
    <div class="account-bar">
        <div class="account-item">
            <div class="account-label">Cash</div>
            <div class="account-value" style="color: var(--accent-green);" id="topBalance">$25,000</div>
        </div>
        <div class="account-item">
            <div class="account-label">Portfolio</div>
            <div class="account-value" style="color: var(--accent-blue);" id="topPortfolio">$0</div>
        </div>
        <div class="account-item">
            <div class="account-label">Total Value</div>
            <div class="account-value" style="color: var(--accent-purple);" id="topTotal">$25,000</div>
        </div>
        <div class="account-item">
            <div class="account-label">Today's P&L</div>
            <div class="account-value" id="topDailyPnL">$0</div>
        </div>
        <div class="account-item">
            <div class="account-label">Total P&L</div>
            <div class="account-value" id="topTotalPnL">$0</div>
        </div>
        <div class="account-item">
            <div class="account-label">Win Rate</div>
            <div class="account-value" id="topWinRate">0%</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <h3>üìå Watchlist</h3>
            <div id="watchlistContainer">
                <div class="watchlist-item" onclick="addToWatchlist()">
                    <span>+ Add Stock</span>
                </div>
            </div>

            <div class="market-scanner">
                <h3>üîç Market Scanner</h3>
                <div class="scanner-tabs">
                    <div class="scanner-tab active" onclick="showScannerTab('gainers')">Gainers</div>
                    <div class="scanner-tab" onclick="showScannerTab('losers')">Losers</div>
                    <div class="scanner-tab" onclick="showScannerTab('active')">Active</div>
                </div>
                <div id="scannerResults"></div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div class="page active" id="page-dashboard">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìä Market Overview</h2>
                        <div>
                            <span class="badge badge-info">26 Stocks</span>
                            <span class="badge badge-success">Live Data</span>
                        </div>
                    </div>
                    <div class="dashboard-grid" id="dashboardStocks"></div>
                </div>

                <!-- Market Heat Map -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üî• Market Heat Map</h2>
                    </div>
                    <div class="heat-map" id="heatMap"></div>
                </div>
            </div>

            <!-- Portfolio Page -->
            <div class="page" id="page-portfolio">
                <div class="card">
                    <h2 class="card-title">üíº Portfolio Overview</h2>
                    <div class="portfolio-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Invested</div>
                            <div class="metric-value" style="color: var(--accent-blue);" id="totalInvested">$0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Current Value</div>
                            <div class="metric-value" style="color: var(--accent-purple);" id="currentValue">$0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Return</div>
                            <div class="metric-value" id="totalReturn">$0</div>
                            <div class="metric-subtext" id="totalReturnPercent">0%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sharpe Ratio</div>
                            <div class="metric-value" id="sharpeRatio">0.00</div>
                            <div class="metric-subtext">Risk-adjusted return</div>
                        </div>
                    </div>
                </div>

                <!-- Diversification Pie Chart -->
                <div class="card">
                    <h2 class="card-title">üìä Portfolio Allocation</h2>
                    <div class="pie-chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>

                <!-- Holdings Table -->
                <div class="card">
                    <h2 class="card-title">üìà Holdings</h2>
                    <div id="holdingsTable"></div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div class="page" id="page-analytics">
                <div class="card">
                    <h2 class="card-title">üìä Performance Analytics</h2>
                    <div class="tabs">
                        <div class="tab active" onclick="showAnalyticsTab('performance')">Performance</div>
                        <div class="tab" onclick="showAnalyticsTab('risk')">Risk Analysis</div>
                        <div class="tab" onclick="showAnalyticsTab('benchmark')">Benchmark</div>
                    </div>
                    <div id="analyticsContent"></div>
                </div>
            </div>

            <!-- Transaction History Page -->
            <div class="page" id="page-history">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üìú Transaction History</h2>
                        <button class="btn btn-primary" onclick="exportTransactions()">üì• Export CSV</button>
                    </div>
                    <div id="transactionTable"></div>
                </div>

                <!-- Tax Report -->
                <div class="card">
                    <h2 class="card-title">üìÑ Tax Report (2026)</h2>
                    <div class="portfolio-grid">
                        <div class="metric-card">
                            <div class="metric-label">Short-term Gains</div>
                            <div class="metric-value" id="shortTermGains">$0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Long-term Gains</div>
                            <div class="metric-value" id="longTermGains">$0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Trades</div>
                            <div class="metric-value" id="totalTrades">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Win/Loss Ratio</div>
                            <div class="metric-value" id="winLossRatio">0:0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watchlist Page -->
            <div class="page" id="page-watchlist">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üëÅÔ∏è My Watchlist</h2>
                        <button class="btn btn-primary" onclick="openAddToWatchlistModal()">+ Add Stock</button>
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Add stocks to your watchlist to track their performance. Click on any stock to view detailed market overview.
                    </p>
                    <div id="watchlistPageContent"></div>
                </div>
            </div>

            <!-- Scanner Page -->
            <div class="page" id="page-scanner">
                <div class="card">
                    <h2 class="card-title">üîç Advanced Market Scanner</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Discover top performing stocks, biggest movers, and trading opportunities.
                    </p>
                    
                    <div class="tabs" id="scannerTabs">
                        <div class="tab active" onclick="showScannerTab('gainers')">üöÄ Top Gainers</div>
                        <div class="tab" onclick="showScannerTab('losers')">üìâ Top Losers</div>
                        <div class="tab" onclick="showScannerTab('active')">üìä Most Active</div>
                        <div class="tab" onclick="showScannerTab('52high')">üìà 52-Week High</div>
                        <div class="tab" onclick="showScannerTab('52low')">üìâ 52-Week Low</div>
                        <div class="tab" onclick="showScannerTab('dividend')">üí∞ High Dividend</div>
                        <div class="tab" onclick="showScannerTab('performers')">üèÜ Best Performers</div>
                    </div>
                    
                    <div id="scannerContent"></div>
                </div>
            </div>

            <!-- Comparison Page -->
            <div class="page" id="page-comparison">
                <div class="card">
                    <h2 class="card-title">‚öñÔ∏è Stock Comparison Tool</h2>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Compare up to 4 stocks side-by-side. View price, fundamentals, and key metrics.
                    </p>
                    
                    <div class="form-group">
                        <label>Select Stocks to Compare (up to 4)</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">
                            <select id="compareStock1" onchange="updateComparison()">
                                <option value="">Stock 1</option>
                            </select>
                            <select id="compareStock2" onchange="updateComparison()">
                                <option value="">Stock 2</option>
                            </select>
                            <select id="compareStock3" onchange="updateComparison()">
                                <option value="">Stock 3 (Optional)</option>
                            </select>
                            <select id="compareStock4" onchange="updateComparison()">
                                <option value="">Stock 4 (Optional)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="compareStocks()" style="margin-top: 10px;">Compare Stocks</button>
                    </div>
                    
                    <div id="comparisonResults"></div>
                </div>
            </div>

            <!-- Goals Page -->
            <div class="page" id="page-goals">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">üéØ Financial Goals</h2>
                        <button class="btn btn-primary" onclick="addGoal()">+ Add Goal</button>
                    </div>
                    <div id="goalsContent"></div>
                </div>

                <!-- Achievements -->
                <div class="card">
                    <h2 class="card-title">üèÜ Achievements</h2>
                    <div class="achievements" id="achievementsBadges"></div>
                </div>
            </div>

            <!-- Education Page -->
            <div class="page" id="page-education">
                <div class="card">
                    <h2 class="card-title">üéì Trading Education</h2>
                    <div class="tabs">
                        <div class="tab active">Basics</div>
                        <div class="tab">Strategies</div>
                        <div class="tab">Risk Management</div>
                        <div class="tab">Glossary</div>
                    </div>
                    <div id="educationContent"></div>
                </div>
            </div>

            <!-- Limit Orders Page -->
            <div class="page" id="page-limit-orders">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">‚ö° Limit Orders</h2>
                        <button class="btn btn-primary" onclick="openLimitOrderModal()">+ Create Limit Order</button>
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">
                        Set automatic buy/sell orders that execute when a stock reaches your target price. 
                        Orders are checked every time prices update.
                    </p>
                    <div id="limitOrdersContainer"></div>
                </div>

                <!-- Active Orders Summary -->
                <div class="card">
                    <h2 class="card-title">üìä Orders Summary</h2>
                    <div class="portfolio-grid">
                        <div class="metric-card">
                            <div class="metric-label">Active Orders</div>
                            <div class="metric-value" id="activeOrdersCount">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Buy Orders</div>
                            <div class="metric-value" style="color: var(--accent-green);" id="buyOrdersCount">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sell Orders</div>
                            <div class="metric-value" style="color: var(--accent-red);" id="sellOrdersCount">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Executed Today</div>
                            <div class="metric-value" id="executedOrdersCount">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Detail Pages (Generated Dynamically) -->
            <div id="stockDetailPages"></div>
        </main>

        <!-- Right Panel -->
        <aside class="right-panel">
            <!-- News Feed -->
            <div class="news-feed">
                <h3 style="margin-bottom: 15px;">üì∞ Market News</h3>
                <div id="newsContainer"></div>
            </div>

            <!-- Active Alerts -->
            <div class="alerts-panel">
                <h3 style="margin-bottom: 15px;">üîî Price Alerts</h3>
                <div id="alertsContainer">
                    <p style="color: var(--text-muted); font-size: 0.9rem;">No active alerts</p>
                </div>
            </div>

            <!-- Economic Calendar -->
            <div class="card" style="padding: 15px;">
                <h3 style="margin-bottom: 15px; font-size: 1rem;">üìÖ Economic Calendar</h3>
                <div id="economicCalendar"></div>
            </div>
        </aside>
    </div>

    <!-- Trade Modal -->
    <div class="modal" id="tradeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tradeModalTitle">Execute Trade</h2>
                <span class="close-modal" onclick="closeModal('tradeModal')">√ó</span>
            </div>
            <div id="tradeModalContent"></div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Price Alert</h2>
                <span class="close-modal" onclick="closeModal('alertModal')">√ó</span>
            </div>
            <div id="alertModalContent"></div>
        </div>
    </div>

    <!-- Limit Order Modal -->
    <div class="modal" id="limitOrderModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö° Create Limit Order</h2>
                <span class="close-modal" onclick="closeModal('limitOrderModal')">√ó</span>
            </div>
            <div class="form-group">
                <label>Order Type</label>
                <select id="limitOrderType" onchange="updateLimitOrderForm()">
                    <option value="BUY">Buy Limit</option>
                    <option value="SELL">Sell Limit</option>
                </select>
            </div>
            <div class="form-group">
                <label>Stock Symbol</label>
                <select id="limitOrderSymbol" onchange="updateLimitOrderPrice()">
                    <option value="">Select a stock</option>
                </select>
            </div>
            <div class="form-group">
                <label>Current Price</label>
                <input type="text" id="limitOrderCurrentPrice" readonly style="background: var(--bg-primary);">
            </div>
            <div class="form-group">
                <label>Target Price (Order executes when price reaches this)</label>
                <input type="number" id="limitOrderTargetPrice" step="0.01" placeholder="Enter target price">
            </div>
            <div class="form-group">
                <label>Number of Shares</label>
                <input type="number" id="limitOrderShares" min="1" value="1" placeholder="Enter shares">
            </div>
            <div class="form-group">
                <label>Total Order Value</label>
                <input type="text" id="limitOrderTotal" readonly style="background: var(--bg-primary);">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1;" onclick="closeModal('limitOrderModal')">Cancel</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="createLimitOrder()">Create Order</button>
            </div>
        </div>
    </div>

    <!-- Add to Watchlist Modal -->
    <div class="modal" id="addWatchlistModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üëÅÔ∏è Add to Watchlist</h2>
                <span class="close-modal" onclick="closeModal('addWatchlistModal')">√ó</span>
            </div>
            <div class="form-group">
                <label>Search and Select Stock</label>
                <input type="text" id="watchlistSearchInput" placeholder="Type stock symbol or name..." oninput="filterWatchlistStocks()">
            </div>
            <div id="watchlistStockOptions" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                <!-- Stock options will be populated here -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // === GLOBAL STATE ===
        const APP_STATE = {
            balance: 25000,
            initialBalance: 25000,
            portfolio: [],
            watchlists: [{ name: 'Default', stocks: [] }],
            priceAlerts: [],
            limitOrders: [],
            transactions: [],
            goals: [],
            achievements: [],
            priceHistory: {},
            currentPage: 'dashboard',
            currentTheme: 'dark',
            currentStock: null,
            currentTimeframe: '1Y',
            chartType: 'line',
            indicators: [],
            scannerFilter: 'gainers'
        };

        // === STOCK DATA ===
        // === NEPSE (Nepal Stock Exchange) Companies ===
        // All prices in NPR (Nepali Rupees). Market cap in Arab (1 Arab = 100 Crore).
        // Fundamental data sourced from merolagani.com, sharesansar.com, sharehubnepal.com
        // Live prices load from NEPSE via /api/prices ‚Äî these are latest known defaults
        const STOCKS = [
            // ‚îÄ‚îÄ Commercial Banks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // NABIL: LTP 489, EPS 26.34, BV 235.58, P/E 18.56, Market Cap 1.3 Kharab (source: sharehubnepal.com, Jan 2026)
            { symbol: 'NABIL', name: 'Nabil Bank Ltd.', price: 489.00, change: 0, changePercent: 0, volume: 45230, bookValue: 235.58, marketCap: '1.3 Kharab', yearReturn: -0.73, dividend: 20, peRatio: 18.56, eps: 26.34, sector: 'Commercial Banks' },
            // NICA: LTP ~450, EPS ~28, BV ~185, P/E ~16 (merolagani estimates Q4 2024/25)
            { symbol: 'NICA', name: 'NIC Asia Bank Ltd.', price: 452.00, change: 0, changePercent: 0, volume: 38410, bookValue: 185.40, marketCap: '83 Arab', yearReturn: 5.2, dividend: 18, peRatio: 16.14, eps: 28.01, sector: 'Commercial Banks' },
            // EBL: One of Nepal's most profitable banks
            { symbol: 'EBL', name: 'Everest Bank Ltd.', price: 695.00, change: 0, changePercent: 0, volume: 22180, bookValue: 310.25, marketCap: '64 Arab', yearReturn: 8.4, dividend: 25, peRatio: 17.82, eps: 39.00, sector: 'Commercial Banks' },
            // HBL: Himalayan Bank - established 1992
            { symbol: 'HBL', name: 'Himalayan Bank Ltd.', price: 510.00, change: 0, changePercent: 0, volume: 28640, bookValue: 240.18, marketCap: '72 Arab', yearReturn: 3.1, dividend: 15, peRatio: 16.45, eps: 31.00, sector: 'Commercial Banks' },
            // SANIMA: Sanima Bank
            { symbol: 'SANIMA', name: 'Sanima Bank Ltd.', price: 330.00, change: 0, changePercent: 0, volume: 19870, bookValue: 168.50, marketCap: '46 Arab', yearReturn: 2.8, dividend: 12, peRatio: 15.00, eps: 22.00, sector: 'Commercial Banks' },
            // SBI: Nepal SBI Bank (subsidiary of State Bank of India)
            { symbol: 'SBI', name: 'Nepal SBI Bank Ltd.', price: 315.00, change: 0, changePercent: 0, volume: 17250, bookValue: 158.30, marketCap: '39 Arab', yearReturn: 4.6, dividend: 13, peRatio: 15.75, eps: 20.00, sector: 'Commercial Banks' },
            // PRVU: Prabhu Bank
            { symbol: 'PRVU', name: 'Prabhu Bank Ltd.', price: 255.00, change: 0, changePercent: 0, volume: 24100, bookValue: 142.60, marketCap: '38 Arab', yearReturn: 1.2, dividend: 10, peRatio: 14.17, eps: 18.00, sector: 'Commercial Banks' },
            // KBL: Kumari Bank
            { symbol: 'KBL', name: 'Kumari Bank Ltd.', price: 248.00, change: 0, changePercent: 0, volume: 21430, bookValue: 138.90, marketCap: '36 Arab', yearReturn: 0.8, dividend: 10, peRatio: 13.78, eps: 18.00, sector: 'Commercial Banks' },
            // NBL: Nepal Bank Limited (oldest bank in Nepal, est. 1937)
            { symbol: 'NBL', name: 'Nepal Bank Ltd.', price: 295.00, change: 0, changePercent: 0, volume: 16800, bookValue: 148.75, marketCap: '41 Arab', yearReturn: 6.5, dividend: 15, peRatio: 14.75, eps: 20.00, sector: 'Commercial Banks' },
            // SCB: Standard Chartered Bank Nepal
            { symbol: 'SCB', name: 'Standard Chartered Bank Nepal', price: 780.00, change: 0, changePercent: 0, volume: 8920, bookValue: 385.40, marketCap: '28 Arab', yearReturn: 11.2, dividend: 40, peRatio: 19.50, eps: 40.00, sector: 'Commercial Banks' },
            // ‚îÄ‚îÄ Development Banks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // MNBBL: Muktinath Bikas Bank - largest development bank
            { symbol: 'MNBBL', name: 'Muktinath Bikas Bank Ltd.', price: 310.00, change: 0, changePercent: 0, volume: 14560, bookValue: 152.30, marketCap: '12 Arab', yearReturn: 3.5, dividend: 12, peRatio: 14.09, eps: 22.00, sector: 'Development Banks' },
            // GBBL: Garima Bikas Bank
            { symbol: 'GBBL', name: 'Garima Bikas Bank Ltd.', price: 285.00, change: 0, changePercent: 0, volume: 11230, bookValue: 145.20, marketCap: '10 Arab', yearReturn: 2.9, dividend: 10, peRatio: 13.57, eps: 21.00, sector: 'Development Banks' },
            // LBBL: Lumbini Bikas Bank
            { symbol: 'LBBL', name: 'Lumbini Bikas Bank Ltd.', price: 272.00, change: 0, changePercent: 0, volume: 9870, bookValue: 138.60, marketCap: '8 Arab', yearReturn: 1.8, dividend: 9, peRatio: 13.10, eps: 20.76, sector: 'Development Banks' },
            // ‚îÄ‚îÄ Life Insurance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // NLIC: Nepal Life Insurance ‚Äî top life insurer by market cap
            { symbol: 'NLIC', name: 'Nepal Life Insurance Co. Ltd.', price: 1285.00, change: 0, changePercent: 0, volume: 6540, bookValue: 445.80, marketCap: '38 Arab', yearReturn: 14.8, dividend: 50, peRatio: 22.60, eps: 56.86, sector: 'Life Insurance' },
            // LICN: Life Insurance Corporation Nepal
            { symbol: 'LICN', name: 'Life Insurance Corp. (Nepal) Ltd.', price: 950.00, change: 0, changePercent: 0, volume: 4210, bookValue: 368.40, marketCap: '22 Arab', yearReturn: 10.5, dividend: 40, peRatio: 20.43, eps: 46.50, sector: 'Life Insurance' },
            // ‚îÄ‚îÄ Non-Life Insurance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // NICL: National Life Insurance
            { symbol: 'NICL', name: 'National Life Insurance Co.', price: 540.00, change: 0, changePercent: 0, volume: 5680, bookValue: 198.50, marketCap: '7 Arab', yearReturn: 7.2, dividend: 20, peRatio: 18.62, eps: 29.00, sector: 'Non-Life Insurance' },
            // PRIN: Premier Insurance
            { symbol: 'PRIN', name: 'Premier Insurance Co.', price: 462.00, change: 0, changePercent: 0, volume: 3940, bookValue: 182.30, marketCap: '5 Arab', yearReturn: 5.8, dividend: 15, peRatio: 16.50, eps: 28.00, sector: 'Non-Life Insurance' },
            // ‚îÄ‚îÄ Hydropower ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // CHCL: Chilime Hydropower ‚Äî oldest listed hydro
            { symbol: 'CHCL', name: 'Chilime Hydropower Co. Ltd.', price: 465.00, change: 0, changePercent: 0, volume: 12380, bookValue: 178.60, marketCap: '13 Arab', yearReturn: 9.2, dividend: 28, peRatio: 19.38, eps: 24.00, sector: 'Hydropower' },
            // BPCL: Butwal Power Company
            { symbol: 'BPCL', name: 'Butwal Power Company Ltd.', price: 298.00, change: 0, changePercent: 0, volume: 8760, bookValue: 152.40, marketCap: '9 Arab', yearReturn: 6.5, dividend: 18, peRatio: 16.56, eps: 18.00, sector: 'Hydropower' },
            // SHPC: Sanima Mai Hydropower
            { symbol: 'SHPC', name: 'Sanima Mai Hydropower Ltd.', price: 218.00, change: 0, changePercent: 0, volume: 18900, bookValue: 128.30, marketCap: '8 Arab', yearReturn: -4.2, dividend: 5, peRatio: 22.45, eps: 9.71, sector: 'Hydropower' },
            // ‚îÄ‚îÄ Microfinance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // SKBBL: Sana Kisan Bikas Bank ‚Äî biggest microfinance
            { symbol: 'SKBBL', name: 'Sana Kisan Bikas Bank Ltd.', price: 1420.00, change: 0, changePercent: 0, volume: 3210, bookValue: 462.50, marketCap: '19 Arab', yearReturn: 18.3, dividend: 60, peRatio: 24.52, eps: 57.91, sector: 'Microfinance' },
            // SWBBL: Swabalamban Bikas Bank
            { symbol: 'SWBBL', name: 'Swabalamban Bikas Bank Ltd.', price: 790.00, change: 0, changePercent: 0, volume: 2840, bookValue: 298.70, marketCap: '8 Arab', yearReturn: 12.1, dividend: 32, peRatio: 20.26, eps: 39.00, sector: 'Microfinance' },
            // ‚îÄ‚îÄ Telecom / Others ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // NTC: Nepal Telecom ‚Äî largest market cap on NEPSE
            { symbol: 'NTC', name: 'Nepal Doorsanchar Co. Ltd.', price: 798.00, change: 0, changePercent: 0, volume: 31420, bookValue: 338.90, marketCap: '1.15 Kharab', yearReturn: 12.5, dividend: 67, peRatio: 16.63, eps: 48.00, sector: 'Telecom' },
            // CIT: Citizen Investment Trust
            { symbol: 'CIT', name: 'Citizen Investment Trust', price: 1580.00, change: 0, changePercent: 0, volume: 1890, bookValue: 498.20, marketCap: '18 Arab', yearReturn: 21.5, dividend: 80, peRatio: 25.45, eps: 62.08, sector: 'Others' },
            // NIFRA: Nepal Infrastructure Bank
            { symbol: 'NIFRA', name: 'Nepal Infrastructure Bank Ltd.', price: 148.00, change: 0, changePercent: 0, volume: 22650, bookValue: 108.40, marketCap: '6 Arab', yearReturn: -8.6, dividend: 0, peRatio: 24.67, eps: 6.00, sector: 'Development Banks' },
            // API: Arun Valley Hydropower
            { symbol: 'API', name: 'Arun Valley Hydropower Dev. Co.', price: 386.00, change: 0, changePercent: 0, volume: 7430, bookValue: 168.20, marketCap: '5 Arab', yearReturn: 4.3, dividend: 12, peRatio: 18.38, eps: 21.00, sector: 'Hydropower' }
        ];

        // === NEPAL MARKET NEWS ===
        const NEWS_ITEMS = [
            { title: 'NRB Keeps Policy Rate Steady at 5.5%, Supports Economic Growth', source: 'Sharesansar', time: '2 hours ago', sentiment: 'neutral' },
            { title: 'NEPSE Index Rises 25 Points on Strong Banking Sector Buying', source: 'Merolagani', time: '3 hours ago', sentiment: 'positive' },
            { title: 'Nepal Telecom (NTC) Declares 67% Cash Dividend for FY 2081/82', source: 'Karobar Daily', time: '5 hours ago', sentiment: 'positive' },
            { title: 'Hydropower Stocks Under Pressure as Monsoon Season Ends', source: 'Arthik Abhiyan', time: '7 hours ago', sentiment: 'negative' },
            { title: 'Nabil Bank Reports Strong Q4 Earnings, EPS at Rs. 26.34', source: 'Sharesansar', time: '1 day ago', sentiment: 'positive' },
            { title: 'SEBON Approves New IPO Guidelines to Boost Capital Market', source: 'New Business Age', time: '1 day ago', sentiment: 'positive' },
            { title: 'Nepal Life Insurance Posts Record Net Profit in FY 2081/82', source: 'Merolagani', time: '2 days ago', sentiment: 'positive' },
            { title: 'Foreign Investment in NEPSE Up 12% as Economy Stabilises', source: 'Republica', time: '2 days ago', sentiment: 'positive' }
        ];

        // === NEPAL ECONOMIC CALENDAR ===
        const ECONOMIC_EVENTS = [
            { date: 'Falgun 5', event: 'NRB Monetary Policy Review', impact: 'high' },
            { date: 'Falgun 8', event: 'NABIL Q2 Earnings Report', impact: 'high' },
            { date: 'Falgun 12', event: 'Nepal GDP Q2 Data Release', impact: 'medium' },
            { date: 'Falgun 15', event: 'NEPSE AGM Season Begins', impact: 'medium' },
            { date: 'Falgun 20', event: 'NTC Dividend Book Closure', impact: 'high' },
            { date: 'Falgun 25', event: 'SEBON Board Meeting', impact: 'medium' }
        ];

        // === ACHIEVEMENTS ===
        const ACHIEVEMENTS = [
            { id: 'first_trade', name: 'First Trade', icon: 'üéØ', description: 'Execute your first trade', unlocked: false },
            { id: 'profitable', name: 'In The Green', icon: 'üí∞', description: 'Make your first profitable trade', unlocked: false },
            { id: 'diversified', name: 'Diversified', icon: 'üìä', description: 'Own 5 different stocks', unlocked: false },
            { id: 'high_roller', name: 'High Roller', icon: 'üíé', description: 'Portfolio value exceeds $50,000', unlocked: false },
            { id: 'day_trader', name: 'Day Trader', icon: '‚ö°', description: 'Execute 10 trades in one day', unlocked: false },
            { id: 'patient', name: 'Patient Investor', icon: 'üïê', description: 'Hold a stock for 30 days', unlocked: false }
        ];

        // Initialize app ‚Äî called by startApp() after login & sync, NOT on DOMContentLoaded
        // (DOMContentLoaded is intentionally removed so auth overlay shows first)

        function initializeApp() {
            initializePriceHistory();
            initialize52WeekData();
            initializeVolumeData();
            renderDashboard();
            renderNews();
            renderEconomicCalendar();
            renderWatchlist();
            renderScanner();
            updateAccountBar();
            
            // Start price updates
            setInterval(updatePrices, 60000);
            
            showNotification('üöÄ Welcome to Finaura Pro Ultimate! All features are now active.', 'info');
        }

        // === 52-WEEK DATA INITIALIZATION ===
        function initialize52WeekData() {
            STOCKS.forEach(stock => {
                // Calculate 52-week high/low based on current price and year return
                const yearChange = stock.yearReturn / 100;
                
                if (yearChange > 0) {
                    // Price went up - current is near high
                    stock.week52High = stock.price;
                    stock.week52Low = stock.price / (1 + yearChange);
                } else {
                    // Price went down - current is near low
                    stock.week52High = stock.price / (1 + yearChange);
                    stock.week52Low = stock.price;
                }
                
                // Add some variance
                stock.week52High = stock.week52High * (1 + Math.random() * 0.05);
                stock.week52Low = stock.week52Low * (0.95 - Math.random() * 0.05);
                
                // Distance from 52-week high
                stock.distanceFromHigh = ((stock.price - stock.week52High) / stock.week52High * 100);
                stock.distanceFromLow = ((stock.price - stock.week52Low) / stock.week52Low * 100);
            });
        }

        // === VOLUME DATA INITIALIZATION ===
        function initializeVolumeData() {
            STOCKS.forEach(stock => {
                // Initialize daily volume history (last 30 days)
                stock.volumeHistory = [];
                for (let i = 0; i < 30; i++) {
                    const variance = (Math.random() - 0.5) * 0.4;
                    stock.volumeHistory.push(Math.floor(stock.volume * (1 + variance)));
                }
                
                // Calculate average volume
                stock.avgVolume = Math.floor(stock.volumeHistory.reduce((sum, v) => sum + v, 0) / stock.volumeHistory.length);
                
                // Volume change vs average
                stock.volumeChange = ((stock.volume - stock.avgVolume) / stock.avgVolume * 100);
            });
        }

        // === PRICE HISTORY INITIALIZATION ===
        function initializePriceHistory() {
            STOCKS.forEach(stock => {
                const history = [];
                const basePrice = stock.price / (1 + (stock.yearReturn / 100));
                
                // Generate 5 years of data
                for (let i = 0; i < 1825; i++) {
                    const dailyVolatility = stock.price * 0.015;
                    const trend = (stock.price - basePrice) * (i / 1825);
                    const randomWalk = (Math.random() - 0.5) * dailyVolatility * 2;
                    history.push(parseFloat((basePrice + trend + randomWalk).toFixed(2)));
                }
                
                APP_STATE.priceHistory[stock.symbol] = history;
            });
        }

        // === THEME TOGGLE ===
        function toggleTheme() {
            const html = document.documentElement;
            const toggle = document.getElementById('themeToggle');
            
            if (APP_STATE.currentTheme === 'dark') {
                html.setAttribute('data-theme', 'light');
                toggle.textContent = '‚òÄÔ∏è';
                APP_STATE.currentTheme = 'light';
            } else {
                html.removeAttribute('data-theme');
                toggle.textContent = 'üåô';
                APP_STATE.currentTheme = 'dark';
            }
        }

        // === PAGE NAVIGATION ===
        function switchPage(page) {
            APP_STATE.currentPage = page;
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            
            const targetPage = document.getElementById(`page-${page}`);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            event.currentTarget.classList.add('active');
            
            // Render page-specific content
            if (page === 'portfolio') renderPortfolioPage();
            if (page === 'analytics') renderAnalyticsPage();
            if (page === 'history') renderHistoryPage();
            if (page === 'goals') renderGoalsPage();
            if (page === 'education') renderEducationPage();
            if (page === 'limit-orders') renderLimitOrdersPage();
            if (page === 'watchlist') renderWatchlistPage();
            if (page === 'comparison') initComparisonPage();
            
            window.scrollTo(0, 0);
        }

        // === DASHBOARD RENDERING ===
        function renderDashboard() {
            const container = document.getElementById('dashboardStocks');
            container.innerHTML = STOCKS.map(stock => `
                <div class="stock-card" onclick="viewStock('${stock.symbol}')">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold;">${stock.symbol}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${stock.name}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.3rem; font-weight: bold;">Rs. ${stock.price.toFixed(2)}</div>
                            <div style="font-size: 0.85rem; color: ${stock.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                                ${stock.change >= 0 ? '‚ñ≤' : '‚ñº'} ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">
                        Vol: ${(stock.volume / 1000000).toFixed(1)}M | MCap: ${stock.marketCap}
                    </div>
                </div>
            `).join('');
            
            renderHeatMap();
        }

        // === HEAT MAP ===
        function renderHeatMap() {
            const container = document.getElementById('heatMap');
            container.innerHTML = STOCKS.map(stock => {
                const intensity = Math.abs(stock.changePercent);
                const color = stock.changePercent >= 0 
                    ? `rgba(16, 185, 129, ${Math.min(intensity / 5, 0.8)})`
                    : `rgba(239, 68, 68, ${Math.min(intensity / 5, 0.8)})`;
                
                return `
                    <div class="heat-map-cell" style="background: ${color};" onclick="viewStock('${stock.symbol}')">
                        <div style="font-weight: bold;">${stock.symbol}</div>
                        <div style="font-size: 0.9rem;">${stock.changePercent >= 0 ? '+' : ''}${stock.changePercent.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');
        }

        // === NEWS FEED ===
        function renderNews() {
            const container = document.getElementById('newsContainer');
            container.innerHTML = NEWS_ITEMS.map(news => `
                <div class="news-item">
                    <div class="news-title">${news.title}</div>
                    <div class="news-meta">${news.source} ‚Ä¢ ${news.time}</div>
                </div>
            `).join('');
        }

        // === ECONOMIC CALENDAR ===
        function renderEconomicCalendar() {
            const container = document.getElementById('economicCalendar');
            container.innerHTML = ECONOMIC_EVENTS.map(event => `
                <div style="padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${event.impact === 'high' ? 'var(--accent-red)' : 'var(--accent-blue)'};">
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${event.date}</div>
                    <div style="font-size: 0.85rem; font-weight: 600;">${event.event}</div>
                </div>
            `).join('');
        }

        // === WATCHLIST ===
        function renderWatchlist() {
            const container = document.getElementById('watchlistContainer');
            const defaultWatchlist = APP_STATE.watchlists[0];
            
            const items = defaultWatchlist.stocks.map(symbol => {
                const stock = STOCKS.find(s => s.symbol === symbol);
                if (!stock) return '';
                
                return `
                    <div class="watchlist-item" onclick="viewStock('${symbol}')">
                        <div>
                            <div style="font-weight: bold;">${symbol}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">Rs. ${stock.price.toFixed(2)}</div>
                        </div>
                        <div style="color: ${stock.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-size: 0.85rem; font-weight: 600;">
                            ${stock.changePercent >= 0 ? '+' : ''}${stock.changePercent.toFixed(2)}%
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="watchlist-item" onclick="addToWatchlist()">
                    <span>+ Add Stock</span>
                </div>
                ${items}
            `;
        }

        function addToWatchlist() {
            const symbol = prompt('Enter stock symbol (e.g., NABIL):');
            if (symbol) {
                const upperSymbol = symbol.toUpperCase();
                if (STOCKS.find(s => s.symbol === upperSymbol)) {
                    if (!APP_STATE.watchlists[0].stocks.includes(upperSymbol)) {
                        APP_STATE.watchlists[0].stocks.push(upperSymbol);
                        renderWatchlist();
                        showNotification(`‚úÖ ${upperSymbol} added to watchlist`);
                    } else {
                        showNotification('Stock already in watchlist', 'error');
                    }
                } else {
                    showNotification('Stock not found', 'error');
                }
            }
        }

        // === MARKET SCANNER ===
        // === ADVANCED MARKET SCANNER ===
        let currentScannerTab = 'gainers';

        function renderScanner() {
            showScannerTab(currentScannerTab);
        }

        function showScannerTab(type) {
            currentScannerTab = type;
            
            // Update tab buttons
            document.querySelectorAll('#scannerTabs .tab').forEach(tab => tab.classList.remove('active'));
            event?.currentTarget?.classList.add('active');
            
            const container = document.getElementById('scannerContent');
            let filtered = [...STOCKS];
            let title = '';
            let description = '';
            
            // Filter and sort based on type
            switch(type) {
                case 'gainers':
                    filtered.sort((a, b) => b.changePercent - a.changePercent);
                    title = 'üöÄ Top Gainers';
                    description = 'Stocks with the highest percentage gains today';
                    break;
                    
                case 'losers':
                    filtered.sort((a, b) => a.changePercent - b.changePercent);
                    title = 'üìâ Top Losers';
                    description = 'Stocks with the largest percentage losses today';
                    break;
                    
                case 'active':
                    filtered.sort((a, b) => b.volume - a.volume);
                    title = 'üìä Most Active';
                    description = 'Stocks with the highest trading volume today';
                    break;
                    
                case '52high':
                    filtered.sort((a, b) => b.distanceFromHigh - a.distanceFromHigh);
                    filtered = filtered.filter(s => s.distanceFromHigh > -5);
                    title = 'üìà Near 52-Week High';
                    description = 'Stocks trading within 5% of their 52-week high';
                    break;
                    
                case '52low':
                    filtered.sort((a, b) => a.distanceFromLow - b.distanceFromLow);
                    filtered = filtered.filter(s => s.distanceFromLow < 10);
                    title = 'üìâ Near 52-Week Low';
                    description = 'Stocks trading within 10% of their 52-week low - potential value plays';
                    break;
                    
                case 'dividend':
                    filtered = filtered.filter(s => s.dividend > 0);
                    filtered.sort((a, b) => (b.dividend / b.price) - (a.dividend / a.price));
                    title = 'üí∞ High Dividend Yield';
                    description = 'Stocks with the highest dividend yields';
                    break;
                    
                case 'performers':
                    filtered.sort((a, b) => b.yearReturn - a.yearReturn);
                    title = 'üèÜ Best Performers (1Y)';
                    description = 'Top performing stocks over the past year';
                    break;
            }
            
            // Limit to top 15 results
            filtered = filtered.slice(0, 15);
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 15px;">üìä</div>
                        <p>No stocks match this criteria</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin: 30px 0 20px;">
                    <h3 style="margin-bottom: 5px;">${title}</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem;">${description}</p>
                </div>
                
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Symbol</th>
                                <th>Company</th>
                                <th>Price</th>
                                <th>Change</th>
                                <th>Volume</th>
                                <th>Avg Volume</th>
                                <th>Volume Change</th>
                                ${type === '52high' || type === '52low' ? '<th>52W High</th><th>52W Low</th><th>Distance</th>' : ''}
                                ${type === 'dividend' ? '<th>Dividend</th><th>Yield</th>' : ''}
                                ${type === 'performers' ? '<th>1Y Return</th>' : ''}
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            filtered.forEach((stock, index) => {
                const rank = index + 1;
                const rankMedal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                const dividendYield = stock.dividend > 0 ? (stock.dividend / stock.price * 100) : 0;
                
                html += `
                    <tr onclick="viewStock('${stock.symbol}')" style="cursor: pointer;">
                        <td><strong>${rankMedal}</strong></td>
                        <td><strong style="color: var(--accent-blue);">${stock.symbol}</strong></td>
                        <td>${stock.name}</td>
                        <td><strong>Rs. ${stock.price.toFixed(2)}</strong></td>
                        <td style="color: ${stock.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                            ${stock.change >= 0 ? '‚ñ≤' : '‚ñº'} ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} 
                            (${stock.changePercent >= 0 ? '+' : ''}${stock.changePercent.toFixed(2)}%)
                        </td>
                        <td>${(stock.volume / 1000000).toFixed(2)}M</td>
                        <td>${(stock.avgVolume / 1000000).toFixed(2)}M</td>
                        <td style="color: ${stock.volumeChange >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                            ${stock.volumeChange >= 0 ? '+' : ''}${stock.volumeChange.toFixed(1)}%
                        </td>
                        ${type === '52high' || type === '52low' ? `
                            <td>Rs. ${stock.week52High.toFixed(2)}</td>
                            <td>Rs. ${stock.week52Low.toFixed(2)}</td>
                            <td style="color: ${stock.distanceFromHigh >= -2 ? 'var(--accent-green)' : 'var(--text-muted)'};">
                                ${stock.distanceFromHigh.toFixed(1)}% from high
                            </td>
                        ` : ''}
                        ${type === 'dividend' ? `
                            <td>Rs. ${stock.dividend.toFixed(2)}</td>
                            <td style="color: var(--accent-green); font-weight: 600;">
                                ${dividendYield.toFixed(2)}%
                            </td>
                        ` : ''}
                        ${type === 'performers' ? `
                            <td style="color: ${stock.yearReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                                ${stock.yearReturn >= 0 ? '+' : ''}${stock.yearReturn.toFixed(1)}%
                            </td>
                        ` : ''}
                        <td>
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.85rem;" 
                                    onclick="event.stopPropagation(); viewStock('${stock.symbol}')">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <!-- Quick Stats Summary -->
                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;">üìà Quick Stats</h4>
                    <div class="portfolio-grid">
                        ${generateScannerStats(filtered, type)}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function generateScannerStats(stocks, type) {
            let stats = '';
            
            if (type === 'gainers') {
                const topGainer = stocks[0];
                const avgGain = stocks.reduce((sum, s) => sum + s.changePercent, 0) / stocks.length;
                const totalVolume = stocks.reduce((sum, s) => sum + s.volume, 0);
                
                stats = `
                    <div class="metric-card">
                        <div class="metric-label">Top Gainer</div>
                        <div class="metric-value">${topGainer.symbol}</div>
                        <div class="metric-subtext" style="color: var(--accent-green);">+${topGainer.changePercent.toFixed(2)}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Average Gain</div>
                        <div class="metric-value" style="color: var(--accent-green);">+${avgGain.toFixed(2)}%</div>
                        <div class="metric-subtext">Across top gainers</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Volume</div>
                        <div class="metric-value">${(totalVolume / 1000000000).toFixed(2)}B</div>
                        <div class="metric-subtext">Combined trading</div>
                    </div>
                `;
            } else if (type === 'losers') {
                const topLoser = stocks[0];
                const avgLoss = stocks.reduce((sum, s) => sum + s.changePercent, 0) / stocks.length;
                
                stats = `
                    <div class="metric-card">
                        <div class="metric-label">Top Loser</div>
                        <div class="metric-value">${topLoser.symbol}</div>
                        <div class="metric-subtext" style="color: var(--accent-red);">${topLoser.changePercent.toFixed(2)}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Average Loss</div>
                        <div class="metric-value" style="color: var(--accent-red);">${avgLoss.toFixed(2)}%</div>
                        <div class="metric-subtext">Across top losers</div>
                    </div>
                `;
            } else if (type === 'active') {
                const mostActive = stocks[0];
                const totalVolume = stocks.reduce((sum, s) => sum + s.volume, 0);
                const avgVolume = totalVolume / stocks.length;
                
                stats = `
                    <div class="metric-card">
                        <div class="metric-label">Most Active</div>
                        <div class="metric-value">${mostActive.symbol}</div>
                        <div class="metric-subtext">${(mostActive.volume / 1000000).toFixed(1)}M shares</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Volume</div>
                        <div class="metric-value">${(totalVolume / 1000000000).toFixed(2)}B</div>
                        <div class="metric-subtext">Across all stocks</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg Volume</div>
                        <div class="metric-value">${(avgVolume / 1000000).toFixed(1)}M</div>
                        <div class="metric-subtext">Per stock</div>
                    </div>
                `;
            } else if (type === 'dividend') {
                const topDividend = stocks[0];
                const topYield = (topDividend.dividend / topDividend.price * 100);
                const avgYield = stocks.reduce((sum, s) => sum + (s.dividend / s.price * 100), 0) / stocks.length;
                
                stats = `
                    <div class="metric-card">
                        <div class="metric-label">Highest Yield</div>
                        <div class="metric-value">${topDividend.symbol}</div>
                        <div class="metric-subtext" style="color: var(--accent-green);">${topYield.toFixed(2)}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Average Yield</div>
                        <div class="metric-value" style="color: var(--accent-green);">${avgYield.toFixed(2)}%</div>
                        <div class="metric-subtext">Across high yielders</div>
                    </div>
                `;
            } else if (type === 'performers') {
                const topPerformer = stocks[0];
                const avgReturn = stocks.reduce((sum, s) => sum + s.yearReturn, 0) / stocks.length;
                
                stats = `
                    <div class="metric-card">
                        <div class="metric-label">Best Performer</div>
                        <div class="metric-value">${topPerformer.symbol}</div>
                        <div class="metric-subtext" style="color: var(--accent-green);">+${topPerformer.yearReturn.toFixed(1)}%</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg 1Y Return</div>
                        <div class="metric-value" style="color: var(--accent-green);">+${avgReturn.toFixed(1)}%</div>
                        <div class="metric-subtext">Top performers</div>
                    </div>
                `;
            } else if (type === '52high') {
                const nearestHigh = stocks[0];
                
                stats = `
                    <div class="metric-card">
                        <div class="metric-label">Closest to High</div>
                        <div class="metric-value">${nearestHigh.symbol}</div>
                        <div class="metric-subtext">${nearestHigh.distanceFromHigh.toFixed(1)}% away</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Stocks Near High</div>
                        <div class="metric-value">${stocks.length}</div>
                        <div class="metric-subtext">Within 5%</div>
                    </div>
                `;
            } else if (type === '52low') {
                const nearestLow = stocks[0];
                
                stats = `
                    <div class="metric-card">
                        <div class="metric-label">Closest to Low</div>
                        <div class="metric-value">${nearestLow.symbol}</div>
                        <div class="metric-subtext">${nearestLow.distanceFromLow.toFixed(1)}% above low</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Potential Values</div>
                        <div class="metric-value">${stocks.length}</div>
                        <div class="metric-subtext">Worth researching</div>
                    </div>
                `;
            }
            
            return stats;
        }

        // === PORTFOLIO PAGE ===
        function renderPortfolioPage() {
            const totalInvested = APP_STATE.portfolio.reduce((sum, h) => sum + (h.avgPrice * h.shares), 0);
            const currentValue = APP_STATE.portfolio.reduce((sum, h) => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                return sum + (stock ? stock.price * h.shares : 0);
            }, 0);
            const totalReturn = currentValue - totalInvested;
            const returnPercent = totalInvested > 0 ? (totalReturn / totalInvested) * 100 : 0;
            
            document.getElementById('totalInvested').textContent = `Rs. ${totalInvested.toFixed(2)}`;
            document.getElementById('currentValue').textContent = `Rs. ${currentValue.toFixed(2)}`;
            
            const returnElem = document.getElementById('totalReturn');
            returnElem.textContent = `${totalReturn >= 0 ? '+' : ''}Rs. ${totalReturn.toFixed(2)}`;
            returnElem.style.color = totalReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            const returnPercentElem = document.getElementById('totalReturnPercent');
            returnPercentElem.textContent = `${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%`;
            returnPercentElem.style.color = totalReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            // Sharpe Ratio (simplified)
            const sharpe = totalInvested > 0 ? (returnPercent / 10) : 0;
            document.getElementById('sharpeRatio').textContent = sharpe.toFixed(2);
            
            // Render pie chart
            renderPieChart();
            
            // Render holdings table
            renderHoldingsTable();
        }

        function renderPieChart() {
            const canvas = document.getElementById('pieChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 400;
            
            if (APP_STATE.portfolio.length === 0) {
                ctx.fillStyle = 'var(--text-muted)';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No holdings to display', 200, 200);
                return;
            }
            
            const total = APP_STATE.portfolio.reduce((sum, h) => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                return sum + (stock ? stock.price * h.shares : 0);
            }, 0);
            
            const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#14b8a6', '#f97316'];
            
            let currentAngle = -Math.PI / 2;
            
            APP_STATE.portfolio.forEach((holding, index) => {
                const stock = STOCKS.find(s => s.symbol === holding.symbol);
                const value = stock ? stock.price * holding.shares : 0;
                const percentage = (value / total);
                const sliceAngle = percentage * 2 * Math.PI;
                
                ctx.beginPath();
                ctx.moveTo(200, 200);
                ctx.arc(200, 200, 150, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                
                // Label
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = 200 + Math.cos(labelAngle) * 100;
                const labelY = 200 + Math.sin(labelAngle) * 100;
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(holding.symbol, labelX, labelY);
                ctx.font = '12px sans-serif';
                ctx.fillText(`${(percentage * 100).toFixed(1)}%`, labelX, labelY + 15);
                
                currentAngle += sliceAngle;
            });
        }

        function renderHoldingsTable() {
            const container = document.getElementById('holdingsTable');
            
            if (APP_STATE.portfolio.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No holdings yet. Start trading!</p>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Shares</th>
                            <th>Avg Price</th>
                            <th>Current</th>
                            <th>Value</th>
                            <th>P&L</th>
                            <th>Return %</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${APP_STATE.portfolio.map(holding => {
                            const stock = STOCKS.find(s => s.symbol === holding.symbol);
                            const current = stock ? stock.price : 0;
                            const value = current * holding.shares;
                            const cost = holding.avgPrice * holding.shares;
                            const pnl = value - cost;
                            const pnlPercent = (pnl / cost) * 100;
                            
                            return `
                                <tr onclick="viewStock('${holding.symbol}')">
                                    <td><strong>${holding.symbol}</strong></td>
                                    <td>${holding.shares}</td>
                                    <td>Rs. ${holding.avgPrice.toFixed(2)}</td>
                                    <td>Rs. ${current.toFixed(2)}</td>
                                    <td><strong>Rs. ${value.toFixed(2)}</strong></td>
                                    <td style="color: ${pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                                        ${pnl >= 0 ? '+' : ''}Rs. ${pnl.toFixed(2)}
                                    </td>
                                    <td style="color: ${pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                                        ${pnl >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // === ANALYTICS PAGE ===
        // === ANALYTICS PAGE ===
        let currentAnalyticsTab = 'performance';

        function renderAnalyticsPage() {
            showAnalyticsTab(currentAnalyticsTab);
        }

        function showAnalyticsTab(tab) {
            currentAnalyticsTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event?.currentTarget?.classList.add('active');
            
            const container = document.getElementById('analyticsContent');
            
            if (tab === 'performance') {
                renderPerformanceTab(container);
            } else if (tab === 'risk') {
                renderRiskAnalysisTab(container);
            } else if (tab === 'benchmark') {
                renderBenchmarkTab(container);
            }
        }

        function renderPerformanceTab(container) {
            const portfolioValue = APP_STATE.portfolio.reduce((sum, h) => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                return sum + (stock ? stock.price * h.shares : 0);
            }, 0);
            
            const invested = APP_STATE.portfolio.reduce((sum, h) => sum + (h.avgPrice * h.shares), 0);
            const totalReturn = portfolioValue - invested;
            const returnPercent = invested > 0 ? (totalReturn / invested * 100) : 0;
            const totalValue = APP_STATE.balance + portfolioValue;
            
            // Calculate time-based returns
            const todayReturn = 0; // Simplified - would need daily tracking
            const monthReturn = returnPercent * 0.3; // Approximation
            const yearReturn = returnPercent;
            
            // Calculate best/worst performers
            const performers = APP_STATE.portfolio.map(h => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                const currentValue = stock.price * h.shares;
                const costBasis = h.avgPrice * h.shares;
                const pnl = currentValue - costBasis;
                const pnlPercent = (pnl / costBasis) * 100;
                return {
                    symbol: h.symbol,
                    pnl: pnl,
                    pnlPercent: pnlPercent
                };
            }).sort((a, b) => b.pnlPercent - a.pnlPercent);
            
            const bestPerformer = performers.length > 0 ? performers[0] : null;
            const worstPerformer = performers.length > 0 ? performers[performers.length - 1] : null;
            
            // Win rate
            const sellTransactions = APP_STATE.transactions.filter(t => t.type === 'SELL');
            const wins = sellTransactions.filter(t => t.pnl > 0).length;
            const losses = sellTransactions.filter(t => t.pnl < 0).length;
            const winRate = sellTransactions.length > 0 ? (wins / sellTransactions.length * 100) : 0;
            
            container.innerHTML = `
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">üìà Portfolio Performance</h3>
                    
                    <!-- Overall Performance Metrics -->
                    <div class="portfolio-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total Value</div>
                            <div class="metric-value" style="color: var(--accent-blue);">Rs. ${totalValue.toLocaleString()}</div>
                            <div class="metric-subtext">Cash + Portfolio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Return</div>
                            <div class="metric-value" style="color: ${totalReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${totalReturn >= 0 ? '+' : ''}Rs. ${totalReturn.toFixed(2)}
                            </div>
                            <div class="metric-subtext">${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Invested</div>
                            <div class="metric-value">Rs. ${invested.toLocaleString()}</div>
                            <div class="metric-subtext">Cost Basis</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Win Rate</div>
                            <div class="metric-value" style="color: ${winRate >= 50 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${winRate.toFixed(1)}%
                            </div>
                            <div class="metric-subtext">${wins}W / ${losses}L</div>
                        </div>
                    </div>
                    
                    <!-- Time-based Returns -->
                    <h3 style="margin: 40px 0 20px;">‚è±Ô∏è Time-Based Returns</h3>
                    <div class="portfolio-grid">
                        <div class="metric-card">
                            <div class="metric-label">Today</div>
                            <div class="metric-value" style="color: ${todayReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${todayReturn >= 0 ? '+' : ''}${todayReturn.toFixed(2)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">This Month</div>
                            <div class="metric-value" style="color: ${monthReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${monthReturn >= 0 ? '+' : ''}${monthReturn.toFixed(2)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">This Year</div>
                            <div class="metric-value" style="color: ${yearReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${yearReturn >= 0 ? '+' : ''}${yearReturn.toFixed(2)}%
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">All Time</div>
                            <div class="metric-value" style="color: ${returnPercent >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Best/Worst Performers -->
                    ${performers.length > 0 ? `
                        <h3 style="margin: 40px 0 20px;">üèÜ Top Performers</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            ${bestPerformer ? `
                                <div class="metric-card" style="border-left: 4px solid var(--accent-green);">
                                    <div class="metric-label">Best Performer</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">${bestPerformer.symbol}</div>
                                    <div style="font-size: 1.2rem; color: var(--accent-green); margin-top: 10px;">
                                        +${bestPerformer.pnlPercent.toFixed(2)}% (${bestPerformer.pnl >= 0 ? '+' : ''}Rs. ${bestPerformer.pnl.toFixed(2)})
                                    </div>
                                </div>
                            ` : ''}
                            ${worstPerformer ? `
                                <div class="metric-card" style="border-left: 4px solid var(--accent-red);">
                                    <div class="metric-label">Worst Performer</div>
                                    <div class="metric-value" style="font-size: 1.5rem;">${worstPerformer.symbol}</div>
                                    <div style="font-size: 1.2rem; color: var(--accent-red); margin-top: 10px;">
                                        ${worstPerformer.pnlPercent.toFixed(2)}% (${worstPerformer.pnl >= 0 ? '+' : ''}Rs. ${worstPerformer.pnl.toFixed(2)})
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : '<p style="text-align: center; color: var(--text-muted); margin: 40px 0;">No holdings to analyze yet</p>'}
                </div>
            `;
        }

        function renderRiskAnalysisTab(container) {
            const portfolioValue = APP_STATE.portfolio.reduce((sum, h) => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                return sum + (stock ? stock.price * h.shares : 0);
            }, 0);
            
            // Calculate concentration risk
            const holdings = APP_STATE.portfolio.map(h => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                const value = stock.price * h.shares;
                return {
                    symbol: h.symbol,
                    value: value,
                    percent: portfolioValue > 0 ? (value / portfolioValue * 100) : 0
                };
            }).sort((a, b) => b.percent - a.percent);
            
            const topHolding = holdings.length > 0 ? holdings[0] : null;
            const concentrationRisk = topHolding ? topHolding.percent : 0;
            
            // Calculate sector diversification
            const sectorAllocation = {};
            APP_STATE.portfolio.forEach(h => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                if (stock) {
                    const value = stock.price * h.shares;
                    sectorAllocation[stock.sector] = (sectorAllocation[stock.sector] || 0) + value;
                }
            });
            
            const sectorCount = Object.keys(sectorAllocation).length;
            const diversificationScore = Math.min((sectorCount / 8) * 100, 100); // 8 major sectors
            
            // Calculate volatility (simplified)
            const avgVolatility = APP_STATE.portfolio.reduce((sum, h) => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                return sum + (stock ? Math.abs(stock.changePercent) : 0);
            }, 0) / Math.max(APP_STATE.portfolio.length, 1);
            
            // Calculate Sharpe Ratio (simplified)
            const invested = APP_STATE.portfolio.reduce((sum, h) => sum + (h.avgPrice * h.shares), 0);
            const totalReturn = portfolioValue - invested;
            const returnPercent = invested > 0 ? (totalReturn / invested * 100) : 0;
            const riskFreeRate = 4.5; // Assumed 4.5% risk-free rate
            const excessReturn = returnPercent - riskFreeRate;
            const sharpeRatio = avgVolatility > 0 ? (excessReturn / (avgVolatility * 10)) : 0;
            
            // Calculate max drawdown (simplified)
            const maxDrawdown = Math.min(returnPercent, 0); // Simplified
            
            // Risk level
            let riskLevel = 'Low';
            let riskColor = 'var(--accent-green)';
            if (concentrationRisk > 50 || avgVolatility > 3 || sectorCount < 3) {
                riskLevel = 'High';
                riskColor = 'var(--accent-red)';
            } else if (concentrationRisk > 30 || avgVolatility > 2 || sectorCount < 5) {
                riskLevel = 'Medium';
                riskColor = 'var(--accent-blue)';
            }
            
            container.innerHTML = `
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">‚ö†Ô∏è Risk Metrics</h3>
                    
                    <!-- Overall Risk Assessment -->
                    <div class="portfolio-grid">
                        <div class="metric-card" style="border-left: 4px solid ${riskColor};">
                            <div class="metric-label">Overall Risk Level</div>
                            <div class="metric-value" style="color: ${riskColor}; font-size: 2rem;">
                                ${riskLevel}
                            </div>
                            <div class="metric-subtext">Portfolio Risk Assessment</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Sharpe Ratio</div>
                            <div class="metric-value">${sharpeRatio.toFixed(2)}</div>
                            <div class="metric-subtext">Risk-Adjusted Return</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Volatility</div>
                            <div class="metric-value">${avgVolatility.toFixed(2)}%</div>
                            <div class="metric-subtext">Avg Price Fluctuation</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Max Drawdown</div>
                            <div class="metric-value" style="color: var(--accent-red);">
                                ${maxDrawdown.toFixed(2)}%
                            </div>
                            <div class="metric-subtext">Largest Loss</div>
                        </div>
                    </div>
                    
                    <!-- Concentration Risk -->
                    <h3 style="margin: 40px 0 20px;">üéØ Concentration Analysis</h3>
                    <div class="portfolio-grid">
                        <div class="metric-card">
                            <div class="metric-label">Largest Position</div>
                            <div class="metric-value">${topHolding ? topHolding.symbol : 'N/A'}</div>
                            <div class="metric-subtext">${concentrationRisk.toFixed(1)}% of portfolio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Concentration Risk</div>
                            <div class="metric-value" style="color: ${concentrationRisk > 50 ? 'var(--accent-red)' : concentrationRisk > 30 ? 'var(--accent-blue)' : 'var(--accent-green)'};">
                                ${concentrationRisk > 50 ? 'High' : concentrationRisk > 30 ? 'Medium' : 'Low'}
                            </div>
                            <div class="metric-subtext">${concentrationRisk.toFixed(1)}% in top position</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Diversification</div>
                            <div class="metric-value" style="color: ${diversificationScore > 70 ? 'var(--accent-green)' : diversificationScore > 40 ? 'var(--accent-blue)' : 'var(--accent-red)'};">
                                ${diversificationScore.toFixed(0)}%
                            </div>
                            <div class="metric-subtext">${sectorCount} sectors</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Holdings Count</div>
                            <div class="metric-value">${APP_STATE.portfolio.length}</div>
                            <div class="metric-subtext">${APP_STATE.portfolio.length < 5 ? 'Consider diversifying' : 'Well diversified'}</div>
                        </div>
                    </div>
                    
                    <!-- Sector Allocation -->
                    ${Object.keys(sectorAllocation).length > 0 ? `
                        <h3 style="margin: 40px 0 20px;">üìä Sector Allocation</h3>
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                            ${Object.entries(sectorAllocation).sort((a, b) => b[1] - a[1]).map(([sector, value]) => {
                                const percent = (value / portfolioValue * 100);
                                return `
                                    <div style="margin-bottom: 15px;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                            <span>${sector}</span>
                                            <span style="font-weight: 600;">${percent.toFixed(1)}% (Rs. ${value.toFixed(2)})</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${percent}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : '<p style="text-align: center; color: var(--text-muted); margin: 40px 0;">No holdings to analyze yet</p>'}
                    
                    <!-- Risk Recommendations -->
                    <h3 style="margin: 40px 0 20px;">üí° Risk Management Tips</h3>
                    <div class="card" style="background: var(--bg-tertiary); padding: 20px;">
                        <ul style="line-height: 2; margin-left: 20px;">
                            ${concentrationRisk > 50 ? '<li style="color: var(--accent-red);">‚ö†Ô∏è <strong>High concentration risk!</strong> Consider reducing your largest position below 30%</li>' : ''}
                            ${sectorCount < 3 ? '<li style="color: var(--accent-red);">‚ö†Ô∏è <strong>Low diversification!</strong> Consider adding stocks from different sectors</li>' : ''}
                            ${APP_STATE.portfolio.length < 5 ? '<li style="color: var(--accent-blue);">üí° Consider holding at least 5-10 different stocks for better diversification</li>' : ''}
                            ${sharpeRatio < 0.5 ? '<li style="color: var(--accent-blue);">üí° Your risk-adjusted returns could be improved - consider rebalancing</li>' : ''}
                            ${avgVolatility > 3 ? '<li style="color: var(--accent-red);">‚ö†Ô∏è High portfolio volatility - consider adding stable dividend stocks</li>' : ''}
                            <li style="color: var(--accent-green);">‚úì Set stop-loss orders to protect against large losses</li>
                            <li style="color: var(--accent-green);">‚úì Never invest more than you can afford to lose</li>
                            <li style="color: var(--accent-green);">‚úì Review and rebalance your portfolio regularly</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        function renderBenchmarkTab(container) {
            const portfolioValue = APP_STATE.portfolio.reduce((sum, h) => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                return sum + (stock ? stock.price * h.shares : 0);
            }, 0);
            
            const invested = APP_STATE.portfolio.reduce((sum, h) => sum + (h.avgPrice * h.shares), 0);
            const totalReturn = portfolioValue - invested;
            const portfolioReturnPercent = invested > 0 ? (totalReturn / invested * 100) : 0;
            
            // Simulated benchmark data (S&P 500)
            const sp500Return = 15.2; // YTD return
            const nasdaqReturn = 22.5; // YTD return
            const dowReturn = 8.7; // YTD return
            
            const vssp500 = portfolioReturnPercent - sp500Return;
            const vsNasdaq = portfolioReturnPercent - nasdaqReturn;
            const vsDow = portfolioReturnPercent - dowReturn;
            
            // Calculate if you invested same amount in benchmarks
            const sp500Value = invested * (1 + sp500Return / 100);
            const nasdaqValue = invested * (1 + nasdaqReturn / 100);
            const dowValue = invested * (1 + dowReturn / 100);
            
            const sp500Diff = (portfolioValue + APP_STATE.balance - APP_STATE.initialBalance) - (sp500Value - invested);
            const nasdaqDiff = (portfolioValue + APP_STATE.balance - APP_STATE.initialBalance) - (nasdaqValue - invested);
            const dowDiff = (portfolioValue + APP_STATE.balance - APP_STATE.initialBalance) - (dowValue - invested);
            
            container.innerHTML = `
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px;">üìà Benchmark Comparison</h3>
                    
                    <!-- Your Performance vs Benchmarks -->
                    <div class="portfolio-grid">
                        <div class="metric-card" style="border-left: 4px solid var(--accent-purple);">
                            <div class="metric-label">Your Portfolio</div>
                            <div class="metric-value" style="color: ${portfolioReturnPercent >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${portfolioReturnPercent >= 0 ? '+' : ''}${portfolioReturnPercent.toFixed(2)}%
                            </div>
                            <div class="metric-subtext">Total Return</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">S&P 500</div>
                            <div class="metric-value" style="color: var(--accent-green);">+${sp500Return}%</div>
                            <div class="metric-subtext">YTD Return</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">NASDAQ</div>
                            <div class="metric-value" style="color: var(--accent-green);">+${nasdaqReturn}%</div>
                            <div class="metric-subtext">YTD Return</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Dow Jones</div>
                            <div class="metric-value" style="color: var(--accent-green);">+${dowReturn}%</div>
                            <div class="metric-subtext">YTD Return</div>
                        </div>
                    </div>
                    
                    <!-- Performance vs Benchmarks -->
                    <h3 style="margin: 40px 0 20px;">‚öñÔ∏è Relative Performance</h3>
                    <div class="portfolio-grid">
                        <div class="metric-card">
                            <div class="metric-label">vs S&P 500</div>
                            <div class="metric-value" style="color: ${vssp500 >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${vssp500 >= 0 ? '+' : ''}${vssp500.toFixed(2)}%
                            </div>
                            <div class="metric-subtext">${vssp500 >= 0 ? 'Outperforming' : 'Underperforming'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">vs NASDAQ</div>
                            <div class="metric-value" style="color: ${vsNasdaq >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${vsNasdaq >= 0 ? '+' : ''}${vsNasdaq.toFixed(2)}%
                            </div>
                            <div class="metric-subtext">${vsNasdaq >= 0 ? 'Outperforming' : 'Underperforming'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">vs Dow Jones</div>
                            <div class="metric-value" style="color: ${vsDow >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${vsDow >= 0 ? '+' : ''}${vsDow.toFixed(2)}%
                            </div>
                            <div class="metric-subtext">${vsDow >= 0 ? 'Outperforming' : 'Underperforming'}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Alpha</div>
                            <div class="metric-value" style="color: ${vssp500 >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${vssp500 >= 0 ? '+' : ''}${vssp500.toFixed(2)}%
                            </div>
                            <div class="metric-subtext">Excess Return</div>
                        </div>
                    </div>
                    
                    <!-- What If Analysis -->
                    <h3 style="margin: 40px 0 20px;">üí≠ What If You Invested in Indexes?</h3>
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px;">
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            If you had invested your Rs. ${invested.toFixed(2)} in these indexes instead:
                        </p>
                        
                        <div class="portfolio-grid">
                            <div class="metric-card" style="background: var(--bg-secondary);">
                                <div class="metric-label">S&P 500 Index</div>
                                <div class="metric-value">Rs. ${sp500Value.toFixed(2)}</div>
                                <div class="metric-subtext" style="color: ${sp500Diff >= 0 ? 'var(--accent-red)' : 'var(--accent-green)'};">
                                    You're ${sp500Diff >= 0 ? 'beating' : 'behind'} by Rs. ${Math.abs(sp500Diff).toFixed(2)}
                                </div>
                            </div>
                            <div class="metric-card" style="background: var(--bg-secondary);">
                                <div class="metric-label">NASDAQ Index</div>
                                <div class="metric-value">Rs. ${nasdaqValue.toFixed(2)}</div>
                                <div class="metric-subtext" style="color: ${nasdaqDiff >= 0 ? 'var(--accent-red)' : 'var(--accent-green)'};">
                                    You're ${nasdaqDiff >= 0 ? 'beating' : 'behind'} by Rs. ${Math.abs(nasdaqDiff).toFixed(2)}
                                </div>
                            </div>
                            <div class="metric-card" style="background: var(--bg-secondary);">
                                <div class="metric-label">Dow Jones Index</div>
                                <div class="metric-value">Rs. ${dowValue.toFixed(2)}</div>
                                <div class="metric-subtext" style="color: ${dowDiff >= 0 ? 'var(--accent-red)' : 'var(--accent-green)'};">
                                    You're ${dowDiff >= 0 ? 'beating' : 'behind'} by Rs. ${Math.abs(dowDiff).toFixed(2)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Benchmark Insights -->
                    <h3 style="margin: 40px 0 20px;">üí° Insights</h3>
                    <div class="card" style="background: var(--bg-tertiary); padding: 20px;">
                        <ul style="line-height: 2; margin-left: 20px;">
                            ${vssp500 > 5 ? '<li style="color: var(--accent-green);">üéâ <strong>Excellent!</strong> You\'re significantly outperforming the S&P 500!</li>' : ''}
                            ${vssp500 >= 0 && vssp500 <= 5 ? '<li style="color: var(--accent-green);">‚úì You\'re beating the S&P 500 - keep up the good work!</li>' : ''}
                            ${vssp500 < 0 ? '<li style="color: var(--accent-red);">üí° You\'re underperforming the S&P 500 - consider reviewing your strategy</li>' : ''}
                            ${portfolioReturnPercent > nasdaqReturn ? '<li style="color: var(--accent-green);">üöÄ You\'re even beating tech-heavy NASDAQ!</li>' : ''}
                            ${Math.abs(portfolioReturnPercent) < 5 ? '<li style="color: var(--accent-blue);">üìä Your returns are relatively flat - consider more active trading</li>' : ''}
                            <li style="color: var(--text-secondary);">üìà The S&P 500 is a good benchmark for diversified portfolios</li>
                            <li style="color: var(--text-secondary);">üíº NASDAQ is tech-heavy, so compare if you focus on technology stocks</li>
                            <li style="color: var(--text-secondary);">üè¢ Dow Jones includes large blue-chip companies</li>
                            ${invested === 0 ? '<li style="color: var(--accent-blue);">üí° Start investing to see how you compare to market indexes!</li>' : ''}
                        </ul>
                    </div>
                </div>
            `;
        }

        // === HISTORY PAGE ===
        function renderHistoryPage() {
            const container = document.getElementById('transactionTable');
            
            if (APP_STATE.transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No transactions yet</p>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Symbol</th>
                            <th>Shares</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${APP_STATE.transactions.map(tx => `
                            <tr>
                                <td>${tx.date}</td>
                                <td><span class="badge ${tx.type === 'BUY' ? 'badge-success' : 'badge-danger'}">${tx.type}</span></td>
                                <td><strong>${tx.symbol}</strong></td>
                                <td>${tx.shares}</td>
                                <td>Rs. ${tx.price.toFixed(2)}</td>
                                <td>Rs. ${tx.total.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            // Update tax metrics
            const wins = APP_STATE.transactions.filter(tx => tx.type === 'SELL' && tx.pnl > 0).length;
            const losses = APP_STATE.transactions.filter(tx => tx.type === 'SELL' && tx.pnl <= 0).length;
            
            document.getElementById('totalTrades').textContent = APP_STATE.transactions.length;
            document.getElementById('winLossRatio').textContent = `${wins}:${losses}`;
        }

        function exportTransactions() {
            if (APP_STATE.transactions.length === 0) {
                showNotification('No transactions to export', 'error');
                return;
            }
            
            let csv = 'Date,Type,Symbol,Shares,Price,Total\n';
            APP_STATE.transactions.forEach(tx => {
                csv += `${tx.date},${tx.type},${tx.symbol},${tx.shares},${tx.price},${tx.total}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transactions.csv';
            a.click();
            
            showNotification('üì• Transactions exported successfully!');
        }

        // === GOALS PAGE ===
        function renderGoalsPage() {
            const container = document.getElementById('goalsContent');
            
            if (APP_STATE.goals.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No goals set. Add your first financial goal!</p>';
            } else {
                container.innerHTML = APP_STATE.goals.map(goal => {
                    const progress = (goal.current / goal.target) * 100;
                    
                    return `
                        <div class="goal-card">
                            <h4>${goal.name}</h4>
                            <div class="goal-progress">
                                <span>Rs. ${goal.current.toFixed(0)} / Rs. ${goal.target.toFixed(0)}</span>
                                <span>${progress.toFixed(1)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Render achievements
            const achievementsContainer = document.getElementById('achievementsBadges');
            achievementsContainer.innerHTML = ACHIEVEMENTS.map(achievement => `
                <div class="achievement-badge ${achievement.unlocked ? '' : 'locked'}" title="${achievement.description}">
                    ${achievement.icon}
                </div>
            `).join('');
        }

        function addGoal() {
            const name = prompt('Goal name (e.g., "Retirement Fund"):');
            if (!name) return;
            
            const target = parseFloat(prompt('Target amount:'));
            if (!target || target <= 0) return;
            
            APP_STATE.goals.push({
                id: Date.now(),
                name,
                target,
                current: 0
            });
            
            renderGoalsPage();
            showNotification('üéØ Goal added successfully!');
        }

        // === EDUCATION PAGE ===
        function renderEducationPage() {
            const container = document.getElementById('educationContent');
            container.innerHTML = `
                <div style="padding: 20px;">
                    <h3>üìö Trading Basics</h3>
                    <p style="margin: 10px 0; line-height: 1.6;">
                        Learn the fundamentals of stock trading, market analysis, and investment strategies.
                        Understanding these concepts will help you make informed trading decisions.
                    </p>
                    
                    <h4 style="margin-top: 20px;">Key Concepts:</h4>
                    <ul style="margin: 10px 0; line-height: 2;">
                        <li><strong>Market Orders:</strong> Buy/sell immediately at current market price</li>
                        <li><strong>Limit Orders:</strong> Set specific price for buy/sell execution</li>
                        <li><strong>Stop Loss:</strong> Automatic sell trigger to limit losses</li>
                        <li><strong>Diversification:</strong> Spread investments across different assets</li>
                        <li><strong>P/E Ratio:</strong> Price-to-earnings ratio for valuation</li>
                        <li><strong>Dividend Yield:</strong> Annual dividend payment as % of price</li>
                    </ul>
                    
                    <h4 style="margin-top: 20px;">Risk Management:</h4>
                    <ul style="margin: 10px 0; line-height: 2;">
                        <li>Never invest more than you can afford to lose</li>
                        <li>Set stop-loss orders to protect your capital</li>
                        <li>Diversify your portfolio across sectors</li>
                        <li>Research before investing</li>
                        <li>Don't let emotions drive decisions</li>
                    </ul>
                </div>
            `;
        }

        // === VIEW STOCK DETAILS ===
        let stockDetailChart = null;
        let currentDetailStock = null;
        let currentDetailPeriod = '1M';

        function viewStock(symbol) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (!stock) return;

            currentDetailStock = stock;
            currentDetailPeriod = '1M';

            // Generate price history for different time periods
            const priceHistory = {
                '1D': generateDetailHistory(stock.price, 24, 0.005, 'hourly'),
                '1W': generateDetailHistory(stock.price, 7, 0.015, 'daily'),
                '1M': generateDetailHistory(stock.price, 30, 0.02, 'daily'),
                '1Y': generateDetailHistory(stock.price, 365, 0.04, 'daily'),
                '5Y': generateDetailHistory(stock.price, 1825, 0.08, 'weekly')
            };

            stock.detailHistory = priceHistory;

            const overlay = document.getElementById('stockDetailOverlay');
            const content = document.getElementById('stockDetailContent');

            const hasBonus = Math.random() > 0.6;
            const bonusText = hasBonus ? '‚úì Special Dividend Declared' : 'None';

            content.innerHTML = `
                <div class="detail-header">
                    <div class="detail-title">
                        <h1>${stock.symbol}</h1>
                        <div class="detail-subtitle">${stock.name} ‚Ä¢ ${stock.sector}</div>
                    </div>
                    <div class="detail-price-box">
                        <div class="detail-price">Rs. ${stock.price.toFixed(2)}</div>
                        <div class="detail-change" style="color: ${stock.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                            ${stock.change >= 0 ? '‚ñ≤' : '‚ñº'} ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                        </div>
                    </div>
                </div>

                <div class="trade-buttons-detail">
                    <button class="trade-btn-detail buy-btn-detail" onclick="openBuyModal('${stock.symbol}')">
                        üõí Buy ${stock.symbol}
                    </button>
                    <button class="trade-btn-detail sell-btn-detail" onclick="openSellModal('${stock.symbol}')">
                        üí∞ Sell ${stock.symbol}
                    </button>
                </div>

                <div style="margin: 15px 0; text-align: center;">
                    <button class="btn" style="padding: 12px 30px;" onclick="openLimitOrderModalForStock('${stock.symbol}')">
                        ‚ö° Set Limit Order
                    </button>
                </div>

                <div class="time-selector">
                    <button class="time-btn ${currentDetailPeriod === '1D' ? 'active' : ''}" onclick="changeDetailPeriod('1D')">1 Day</button>
                    <button class="time-btn ${currentDetailPeriod === '1W' ? 'active' : ''}" onclick="changeDetailPeriod('1W')">1 Week</button>
                    <button class="time-btn ${currentDetailPeriod === '1M' ? 'active' : ''}" onclick="changeDetailPeriod('1M')">1 Month</button>
                    <button class="time-btn ${currentDetailPeriod === '1Y' ? 'active' : ''}" onclick="changeDetailPeriod('1Y')">1 Year</button>
                    <button class="time-btn ${currentDetailPeriod === '5Y' ? 'active' : ''}" onclick="changeDetailPeriod('5Y')">5 Years</button>
                </div>

                <div class="detail-chart-container">
                    <canvas id="detailStockChart"></canvas>
                </div>

                <h3 style="margin: 30px 0 15px; font-size: 1.5rem;">üìä Key Metrics</h3>
                <div class="metrics-grid-detail">
                    <div class="metric-card-detail">
                        <div class="metric-label-detail">Market Cap</div>
                        <div class="metric-value-detail">${stock.marketCap}</div>
                    </div>
                    <div class="metric-card-detail">
                        <div class="metric-label-detail">P/E Ratio</div>
                        <div class="metric-value-detail">${stock.peRatio}</div>
                    </div>
                    <div class="metric-card-detail">
                        <div class="metric-label-detail">Book Value</div>
                        <div class="metric-value-detail">${stock.bookValue > 0 ? 'Rs.' + stock.bookValue.toFixed(2) : 'N/A'}</div>
                    </div>
                    <div class="metric-card-detail">
                        <div class="metric-label-detail">EPS</div>
                        <div class="metric-value-detail">Rs. ${stock.eps.toFixed(2)}</div>
                    </div>
                    <div class="metric-card-detail">
                        <div class="metric-label-detail">Dividend</div>
                        <div class="metric-value-detail">${stock.dividend > 0 ? 'Rs.' + stock.dividend.toFixed(2) : 'None'}</div>
                    </div>
                    <div class="metric-card-detail">
                        <div class="metric-label-detail">365-Day Return</div>
                        <div class="metric-value-detail" style="color: ${stock.yearReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                            ${stock.yearReturn >= 0 ? '+' : ''}${stock.yearReturn.toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric-card-detail">
                        <div class="metric-label-detail">Volume</div>
                        <div class="metric-value-detail">${(stock.volume / 1000000).toFixed(1)}M</div>
                    </div>
                    <div class="metric-card-detail">
                        <div class="metric-label-detail">Bonus/Special Dividend</div>
                        <div class="metric-value-detail" style="font-size: 1.3rem;">${bonusText}</div>
                    </div>
                </div>
            `;

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Render chart
            setTimeout(() => renderDetailChart(), 100);
        }

        function generateDetailHistory(basePrice, periods, volatility, type) {
            const history = [];
            let price = basePrice * (1 - volatility / 2); // Start slightly lower
            
            for (let i = 0; i < periods; i++) {
                const trend = (volatility / periods) * i; // Gradual trend
                const random = (Math.random() - 0.5) * (basePrice * volatility * 0.5);
                price = basePrice * (1 - volatility / 2 + trend) + random;
                price = Math.max(price, 0.01);
                history.push(parseFloat(price.toFixed(2)));
            }
            
            return history;
        }

        function changeDetailPeriod(period) {
            currentDetailPeriod = period;
            
            // Update button states
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderDetailChart();
        }

        function renderDetailChart() {
            if (stockDetailChart) {
                stockDetailChart.destroy();
            }

            const stock = currentDetailStock;
            const priceData = stock.detailHistory[currentDetailPeriod];
            const isPositive = priceData[priceData.length - 1] >= priceData[0];

            const labels = priceData.map((_, i) => {
                if (currentDetailPeriod === '1D') return i + 'h';
                if (currentDetailPeriod === '1W') return 'Day ' + (i + 1);
                if (currentDetailPeriod === '1M') return 'D' + (i + 1);
                if (currentDetailPeriod === '1Y') return i % 30 === 0 ? 'M' + Math.floor(i / 30) : '';
                if (currentDetailPeriod === '5Y') return i % 52 === 0 ? 'Y' + Math.floor(i / 365) : '';
                return '';
            });

            const ctx = document.getElementById('detailStockChart').getContext('2d');
            
            stockDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: stock.symbol + ' Price',
                        data: priceData,
                        borderColor: isPositive ? '#10b981' : '#ef4444',
                        backgroundColor: isPositive ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: isPositive ? '#10b981' : '#ef4444',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: isPositive ? '#10b981' : '#ef4444',
                            borderWidth: 2,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return labels[context[0].dataIndex];
                                },
                                label: function(context) {
                                    return 'Price: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false,
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                maxTicksLimit: 12,
                                color: '#94a3b8',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return 'Rs.' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function closeStockDetail() {
            document.getElementById('stockDetailOverlay').classList.remove('active');
            document.body.style.overflow = 'auto';
            
            if (stockDetailChart) {
                stockDetailChart.destroy();
                stockDetailChart = null;
            }
        }

        // === SEARCH STOCKS ===
        function searchStocks() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            if (!term) {
                renderDashboard();
                return;
            }
            
            const filtered = STOCKS.filter(s => 
                s.symbol.toLowerCase().includes(term) || 
                s.name.toLowerCase().includes(term)
            );
            
            const container = document.getElementById('dashboardStocks');
            container.innerHTML = filtered.map(stock => `
                <div class="stock-card" onclick="viewStock('${stock.symbol}')">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold;">${stock.symbol}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">${stock.name}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.3rem; font-weight: bold;">Rs. ${stock.price.toFixed(2)}</div>
                            <div style="font-size: 0.85rem; color: ${stock.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                                ${stock.change >= 0 ? '‚ñ≤' : '‚ñº'} ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // === UPDATE ACCOUNT BAR ===
        function updateAccountBar() {
            const portfolioValue = APP_STATE.portfolio.reduce((sum, h) => {
                const stock = STOCKS.find(s => s.symbol === h.symbol);
                return sum + (stock ? stock.price * h.shares : 0);
            }, 0);
            
            const invested = APP_STATE.portfolio.reduce((sum, h) => sum + (h.avgPrice * h.shares), 0);
            const totalPnL = portfolioValue - invested;
            
            document.getElementById('topBalance').textContent = `Rs. ${APP_STATE.balance.toLocaleString()}`;
            document.getElementById('topPortfolio').textContent = `Rs. ${portfolioValue.toLocaleString()}`;
            document.getElementById('topTotal').textContent = `Rs. ${(APP_STATE.balance + portfolioValue).toLocaleString()}`;
            
            const pnlElem = document.getElementById('topTotalPnL');
            pnlElem.textContent = `${totalPnL >= 0 ? '+' : ''}Rs. ${totalPnL.toFixed(0)}`;
            pnlElem.style.color = totalPnL >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            // Win rate
            const wins = APP_STATE.transactions.filter(tx => tx.type === 'SELL' && tx.pnl > 0).length;
            const total = APP_STATE.transactions.filter(tx => tx.type === 'SELL').length;
            const winRate = total > 0 ? (wins / total) * 100 : 0;
            document.getElementById('topWinRate').textContent = `${winRate.toFixed(0)}%`;
        }

        // === UPDATE PRICES ===
        async function updatePrices() {
            try {
                const r = await fetch('/api/prices');
                if (r.ok) {
                    const d = await r.json();
                    if (d.prices && d.prices.length > 0) {
                        d.prices.forEach(live => {
                            const sym = live.symbol.replace('-', '.');
                            const stock = STOCKS.find(s => s.symbol === sym || s.symbol === live.symbol);
                            if (!stock) return;
                            stock.price         = live.price;
                            stock.change        = live.change;
                            stock.changePercent = live.changePercent;
                            stock.volume        = live.volume;
                            if (APP_STATE.priceHistory[stock.symbol]) {
                                APP_STATE.priceHistory[stock.symbol].push(stock.price);
                            }
                            if (stock.price > stock.week52High) stock.week52High = stock.price;
                            if (stock.price < stock.week52Low)  stock.week52Low  = stock.price;
                            stock.distanceFromHigh = ((stock.price - stock.week52High) / stock.week52High * 100);
                            stock.distanceFromLow  = ((stock.price - stock.week52Low)  / stock.week52Low  * 100);
                        });
                    }
                }
            } catch(e) { /* server unreachable, skip update */ }

            checkLimitOrders();
            renderDashboard();
            renderWatchlist();
            renderScanner();
            updateAccountBar();
            if (APP_STATE.currentPage === 'portfolio') renderPortfolioPage();
            if (APP_STATE.currentPage === 'limit-orders') renderLimitOrdersPage();
            if (APP_STATE.currentPage === 'scanner') showScannerTab(currentScannerTab);
        }

        // === MODAL FUNCTIONS ===
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // === NOTIFICATION SYSTEM ===
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification show ${type}`;
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 3000);
        }

        // This is a DEMO with core infrastructure
        // Full implementations of all 30 features would require significantly more code
        // Key features demonstrated:
        // ‚úÖ Dark/Light theme
        // ‚úÖ Portfolio analytics with pie chart
        // ‚úÖ Transaction history & export
        // ‚úÖ Market scanner
        // ‚úÖ Watchlist
        // ‚úÖ News feed
        // ‚úÖ Economic calendar
        // ‚úÖ Goals & achievements
        // ‚úÖ Educational content
        // ‚úÖ Heat map
        // ‚úÖ Advanced UI/UX

        // === BUY/SELL MODAL FUNCTIONS ===
        function openBuyModal(symbol) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (!stock) return;
            
            const modal = document.getElementById('tradeModal');
            const title = document.getElementById('tradeModalTitle');
            const content = document.getElementById('tradeModalContent');
            
            title.textContent = `Buy ${symbol}`;
            title.style.color = 'var(--accent-green)';
            
            content.innerHTML = `
                <div class="form-group">
                    <label>Stock</label>
                    <input type="text" value="${symbol} - ${stock.name}" readonly style="background: var(--bg-primary);">
                </div>
                <div class="form-group">
                    <label>Current Price</label>
                    <input type="text" value="Rs. ${stock.price.toFixed(2)}" readonly style="background: var(--bg-primary);">
                </div>
                <div class="form-group">
                    <label>Number of Shares</label>
                    <input type="number" id="buyShares" min="1" value="1" oninput="updateBuyTotal('${symbol}')">
                </div>
                <div class="form-group">
                    <label>Total Cost</label>
                    <input type="text" id="buyTotal" value="Rs. ${stock.price.toFixed(2)}" readonly style="background: var(--bg-primary);">
                </div>
                <div class="form-group">
                    <label>Available Cash</label>
                    <input type="text" value="Rs. ${APP_STATE.balance.toLocaleString()}" readonly style="background: var(--bg-primary); color: var(--accent-green);">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" style="flex: 1;" onclick="closeModal('tradeModal')">Cancel</button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="executeBuy('${symbol}')">Buy</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function openSellModal(symbol) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (!stock) return;
            
            const holding = APP_STATE.portfolio.find(h => h.symbol === symbol);
            const sharesOwned = holding ? holding.shares : 0;
            
            if (sharesOwned === 0) {
                showNotification(`‚ùå You don't own any ${symbol} shares`, 'error');
                return;
            }
            
            const modal = document.getElementById('tradeModal');
            const title = document.getElementById('tradeModalTitle');
            const content = document.getElementById('tradeModalContent');
            
            title.textContent = `Sell ${symbol}`;
            title.style.color = 'var(--accent-red)';
            
            const avgPrice = holding.avgPrice;
            const currentValue = stock.price * sharesOwned;
            const totalPnL = (stock.price - avgPrice) * sharesOwned;
            
            content.innerHTML = `
                <div class="form-group">
                    <label>Stock</label>
                    <input type="text" value="${symbol} - ${stock.name}" readonly style="background: var(--bg-primary);">
                </div>
                <div class="form-group">
                    <label>Current Price</label>
                    <input type="text" value="Rs. ${stock.price.toFixed(2)}" readonly style="background: var(--bg-primary);">
                </div>
                <div class="form-group">
                    <label>Shares Owned</label>
                    <input type="text" value="${sharesOwned} shares (Avg: Rs. ${avgPrice.toFixed(2)})" readonly style="background: var(--bg-primary);">
                </div>
                <div class="form-group">
                    <label>Number of Shares to Sell</label>
                    <input type="number" id="sellShares" min="1" max="${sharesOwned}" value="${sharesOwned}" oninput="updateSellTotal('${symbol}', ${sharesOwned}, ${avgPrice})">
                </div>
                <div class="form-group">
                    <label>Total Proceeds</label>
                    <input type="text" id="sellTotal" value="Rs. ${currentValue.toFixed(2)}" readonly style="background: var(--bg-primary);">
                </div>
                <div class="form-group">
                    <label>Estimated P&L</label>
                    <input type="text" id="sellPnL" value="${totalPnL >= 0 ? '+' : ''}Rs. ${totalPnL.toFixed(2)}" readonly style="background: var(--bg-primary); color: ${totalPnL >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn" style="flex: 1;" onclick="closeModal('tradeModal')">Cancel</button>
                    <button class="btn btn-danger" style="flex: 1;" onclick="executeSell('${symbol}', ${sharesOwned})">Sell</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function updateBuyTotal(symbol) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (!stock) return;
            
            const shares = parseInt(document.getElementById('buyShares').value) || 0;
            const total = shares * stock.price;
            document.getElementById('buyTotal').value = 'Rs.' + total.toFixed(2);
        }

        function updateSellTotal(symbol, maxShares, avgPrice) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (!stock) return;
            
            let shares = parseInt(document.getElementById('sellShares').value) || 0;
            if (shares > maxShares) shares = maxShares;
            document.getElementById('sellShares').value = shares;
            
            const total = shares * stock.price;
            const pnl = (stock.price - avgPrice) * shares;
            
            document.getElementById('sellTotal').value = 'Rs.' + total.toFixed(2);
            const pnlInput = document.getElementById('sellPnL');
            pnlInput.value = (pnl >= 0 ? '+' : '') + 'Rs.' + pnl.toFixed(2);
            pnlInput.style.color = pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        }

        async function executeBuy(symbol) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (!stock) return;

            const shares = parseInt(document.getElementById('buyShares').value);
            if (!shares || shares <= 0) {
                showNotification('‚ùå Please enter a valid number of shares', 'error');
                return;
            }

            const totalCost = shares * stock.price;
            if (totalCost > APP_STATE.balance) {
                showNotification('‚ùå Insufficient funds!', 'error');
                return;
            }

            try {
                const r = await fetch('/api/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, shares, price: stock.price })
                });
                const d = await r.json();
                if (r.ok) {
                    await syncFromServer();
                    closeModal('tradeModal');
                    showNotification(`‚úÖ Bought ${shares} shares of ${symbol} at Rs. ${stock.price.toFixed(2)}`);
                    updateAccountBar();
                    if (APP_STATE.currentPage === 'portfolio') renderPortfolioPage();
                } else {
                    showNotification('‚ùå ' + (d.error || 'Trade failed'), 'error');
                }
            } catch(e) {
                showNotification('‚ùå Server error ‚Äî could not save trade', 'error');
            }
        }

        async function executeSell(symbol, maxShares) {
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (!stock) return;

            const shares = parseInt(document.getElementById('sellShares').value);
            if (!shares || shares <= 0 || shares > maxShares) {
                showNotification('‚ùå Invalid number of shares', 'error');
                return;
            }

            const holding = APP_STATE.portfolio.find(h => h.symbol === symbol);
            if (!holding) return;
            const pnl = (stock.price - holding.avgPrice) * shares;

            try {
                const r = await fetch('/api/sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, shares, price: stock.price })
                });
                const d = await r.json();
                if (r.ok) {
                    await syncFromServer();
                    closeModal('tradeModal');
                    showNotification(`‚úÖ Sold ${shares} shares of ${symbol} at Rs. ${stock.price.toFixed(2)} (P&L: ${pnl >= 0 ? '+' : ''}Rs. ${pnl.toFixed(2)})`);
                    updateAccountBar();
                    if (APP_STATE.currentPage === 'portfolio') renderPortfolioPage();
                } else {
                    showNotification('‚ùå ' + (d.error || 'Trade failed'), 'error');
                }
            } catch(e) {
                showNotification('‚ùå Server error ‚Äî could not save trade', 'error');
            }
        }

        // === LIMIT ORDERS SYSTEM ===
        function openLimitOrderModal() {
            const modal = document.getElementById('limitOrderModal');
            const symbolSelect = document.getElementById('limitOrderSymbol');
            
            // Populate stock options
            symbolSelect.innerHTML = '<option value="">Select a stock</option>' + 
                STOCKS.map(s => `<option value="${s.symbol}">${s.symbol} - ${s.name}</option>`).join('');
            
            // Reset form
            document.getElementById('limitOrderType').value = 'BUY';
            document.getElementById('limitOrderSymbol').value = '';
            document.getElementById('limitOrderCurrentPrice').value = '';
            document.getElementById('limitOrderTargetPrice').value = '';
            document.getElementById('limitOrderShares').value = '1';
            document.getElementById('limitOrderTotal').value = '';
            
            modal.classList.add('active');
        }

        function openLimitOrderModalForStock(symbol) {
            openLimitOrderModal();
            
            // Pre-select the stock
            setTimeout(() => {
                document.getElementById('limitOrderSymbol').value = symbol;
                updateLimitOrderPrice();
            }, 50);
        }

        function updateLimitOrderPrice() {
            const symbol = document.getElementById('limitOrderSymbol').value;
            if (!symbol) {
                document.getElementById('limitOrderCurrentPrice').value = '';
                return;
            }
            
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (stock) {
                document.getElementById('limitOrderCurrentPrice').value = `Rs. ${stock.price.toFixed(2)}`;
                updateLimitOrderTotal();
            }
        }

        function updateLimitOrderForm() {
            updateLimitOrderTotal();
        }

        function updateLimitOrderTotal() {
            const targetPrice = parseFloat(document.getElementById('limitOrderTargetPrice').value) || 0;
            const shares = parseInt(document.getElementById('limitOrderShares').value) || 0;
            const total = targetPrice * shares;
            
            if (total > 0) {
                document.getElementById('limitOrderTotal').value = `Rs. ${total.toFixed(2)}`;
            } else {
                document.getElementById('limitOrderTotal').value = '';
            }
        }

        // Update total when inputs change
        document.addEventListener('DOMContentLoaded', function() {
            const targetPriceInput = document.getElementById('limitOrderTargetPrice');
            const sharesInput = document.getElementById('limitOrderShares');
            
            if (targetPriceInput) targetPriceInput.addEventListener('input', updateLimitOrderTotal);
            if (sharesInput) sharesInput.addEventListener('input', updateLimitOrderTotal);
        });

        function createLimitOrder() {
            const type = document.getElementById('limitOrderType').value;
            const symbol = document.getElementById('limitOrderSymbol').value;
            const targetPrice = parseFloat(document.getElementById('limitOrderTargetPrice').value);
            const shares = parseInt(document.getElementById('limitOrderShares').value);
            
            if (!symbol) {
                showNotification('‚ùå Please select a stock', 'error');
                return;
            }
            
            if (!targetPrice || targetPrice <= 0) {
                showNotification('‚ùå Please enter a valid target price', 'error');
                return;
            }
            
            if (!shares || shares <= 0) {
                showNotification('‚ùå Please enter a valid number of shares', 'error');
                return;
            }
            
            const stock = STOCKS.find(s => s.symbol === symbol);
            if (!stock) return;
            
            // Validation for buy/sell orders
            if (type === 'BUY') {
                const totalCost = targetPrice * shares;
                if (totalCost > APP_STATE.balance) {
                    showNotification('‚ùå Insufficient funds for this order', 'error');
                    return;
                }
                
                // Buy limit should be below current price
                if (targetPrice >= stock.price) {
                    const confirm = window.confirm(
                        `Notice: Buy limit price (Rs. ${targetPrice}) is at or above current price (Rs. ${stock.price.toFixed(2)}). ` +
                        `Typically, buy limits are set below current price. Continue anyway?`
                    );
                    if (!confirm) return;
                }
            } else {
                // Check if user has enough shares
                const holding = APP_STATE.portfolio.find(h => h.symbol === symbol);
                if (!holding || holding.shares < shares) {
                    showNotification(`‚ùå You don't have enough ${symbol} shares to sell`, 'error');
                    return;
                }
                
                // Sell limit should be above current price
                if (targetPrice <= stock.price) {
                    const confirm = window.confirm(
                        `Notice: Sell limit price (Rs. ${targetPrice}) is at or below current price (Rs. ${stock.price.toFixed(2)}). ` +
                        `Typically, sell limits are set above current price. Continue anyway?`
                    );
                    if (!confirm) return;
                }
            }
            
            const order = {
                id: Date.now(),
                type: type,
                symbol: symbol,
                targetPrice: targetPrice,
                shares: shares,
                createdAt: new Date().toLocaleString(),
                status: 'ACTIVE'
            };
            
            APP_STATE.limitOrders.push(order);
            
            closeModal('limitOrderModal');
            showNotification(`‚úÖ ${type} limit order created for ${shares} ${symbol} @ Rs. ${targetPrice.toFixed(2)}`);
            
            if (APP_STATE.currentPage === 'limit-orders') {
                renderLimitOrdersPage();
            }
        }

        function checkLimitOrders() {
            const ordersToExecute = [];
            
            APP_STATE.limitOrders.forEach(order => {
                if (order.status !== 'ACTIVE') return;
                
                const stock = STOCKS.find(s => s.symbol === order.symbol);
                if (!stock) return;
                
                let shouldExecute = false;
                
                if (order.type === 'BUY') {
                    // Buy when current price <= target price
                    if (stock.price <= order.targetPrice) {
                        shouldExecute = true;
                    }
                } else {
                    // Sell when current price >= target price
                    if (stock.price >= order.targetPrice) {
                        shouldExecute = true;
                    }
                }
                
                if (shouldExecute) {
                    ordersToExecute.push(order);
                }
            });
            
            // Execute orders
            ordersToExecute.forEach(order => {
                executeLimitOrder(order);
            });
        }

        function executeLimitOrder(order) {
            const stock = STOCKS.find(s => s.symbol === order.symbol);
            if (!stock) return;
            
            const totalValue = stock.price * order.shares;
            
            if (order.type === 'BUY') {
                if (totalValue > APP_STATE.balance) {
                    order.status = 'FAILED';
                    order.failReason = 'Insufficient funds';
                    showNotification(`‚ö†Ô∏è Limit order failed: Insufficient funds for ${order.symbol}`, 'error');
                    return;
                }
                
                APP_STATE.balance -= totalValue;
                
                const existing = APP_STATE.portfolio.find(h => h.symbol === order.symbol);
                if (existing) {
                    const totalShares = existing.shares + order.shares;
                    const totalCost = (existing.avgPrice * existing.shares) + totalValue;
                    existing.avgPrice = totalCost / totalShares;
                    existing.shares = totalShares;
                } else {
                    APP_STATE.portfolio.push({
                        symbol: order.symbol,
                        shares: order.shares,
                        avgPrice: stock.price
                    });
                }
                
                APP_STATE.transactions.push({
                    id: Date.now(),
                    type: 'BUY',
                    symbol: order.symbol,
                    shares: order.shares,
                    price: stock.price,
                    total: totalValue,
                    date: new Date().toLocaleString(),
                    method: 'LIMIT ORDER'
                });
                
                order.status = 'EXECUTED';
                order.executedAt = new Date().toLocaleString();
                order.executedPrice = stock.price;
                
                showNotification(
                    `‚úÖ LIMIT ORDER EXECUTED: Bought ${order.shares} ${order.symbol} @ Rs. ${stock.price.toFixed(2)}`,
                    'success'
                );
                
            } else {
                const holding = APP_STATE.portfolio.find(h => h.symbol === order.symbol);
                if (!holding || holding.shares < order.shares) {
                    order.status = 'FAILED';
                    order.failReason = 'Insufficient shares';
                    showNotification(`‚ö†Ô∏è Limit order failed: Insufficient ${order.symbol} shares`, 'error');
                    return;
                }
                
                APP_STATE.balance += totalValue;
                holding.shares -= order.shares;
                
                if (holding.shares === 0) {
                    APP_STATE.portfolio = APP_STATE.portfolio.filter(h => h.symbol !== order.symbol);
                }
                
                const pnl = (stock.price - holding.avgPrice) * order.shares;
                
                APP_STATE.transactions.push({
                    id: Date.now(),
                    type: 'SELL',
                    symbol: order.symbol,
                    shares: order.shares,
                    price: stock.price,
                    total: totalValue,
                    pnl: pnl,
                    date: new Date().toLocaleString(),
                    method: 'LIMIT ORDER'
                });
                
                order.status = 'EXECUTED';
                order.executedAt = new Date().toLocaleString();
                order.executedPrice = stock.price;
                
                showNotification(
                    `‚úÖ LIMIT ORDER EXECUTED: Sold ${order.shares} ${order.symbol} @ Rs. ${stock.price.toFixed(2)} (P&L: ${pnl >= 0 ? '+' : ''}Rs. ${pnl.toFixed(2)})`,
                    'success'
                );
            }
            
            updateAccountBar();
            
            if (APP_STATE.currentPage === 'limit-orders') {
                renderLimitOrdersPage();
            }
        }

        function renderLimitOrdersPage() {
            const container = document.getElementById('limitOrdersContainer');
            
            const activeOrders = APP_STATE.limitOrders.filter(o => o.status === 'ACTIVE');
            const executedOrders = APP_STATE.limitOrders.filter(o => o.status === 'EXECUTED');
            const failedOrders = APP_STATE.limitOrders.filter(o => o.status === 'FAILED');
            
            // Update summary
            document.getElementById('activeOrdersCount').textContent = activeOrders.length;
            document.getElementById('buyOrdersCount').textContent = activeOrders.filter(o => o.type === 'BUY').length;
            document.getElementById('sellOrdersCount').textContent = activeOrders.filter(o => o.type === 'SELL').length;
            document.getElementById('executedOrdersCount').textContent = executedOrders.filter(o => {
                const orderDate = new Date(o.executedAt);
                const today = new Date();
                return orderDate.toDateString() === today.toDateString();
            }).length;
            
            if (APP_STATE.limitOrders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">‚ö°</div>
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No Limit Orders Yet</h3>
                        <p style="color: var(--text-muted);">Create your first limit order to automate your trading</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            if (activeOrders.length > 0) {
                html += '<h3 style="margin: 20px 0 15px; color: var(--accent-green);">üü¢ Active Orders</h3>';
                html += '<table><thead><tr>';
                html += '<th>Symbol</th><th>Type</th><th>Target Price</th><th>Shares</th><th>Current Price</th><th>Status</th><th>Created</th><th>Action</th>';
                html += '</tr></thead><tbody>';
                
                activeOrders.forEach(order => {
                    const stock = STOCKS.find(s => s.symbol === order.symbol);
                    const currentPrice = stock ? stock.price : 0;
                    const distance = stock ? ((order.targetPrice - currentPrice) / currentPrice * 100) : 0;
                    
                    html += `<tr>
                        <td><strong>${order.symbol}</strong></td>
                        <td><span style="color: ${order.type === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${order.type}</span></td>
                        <td>Rs. ${order.targetPrice.toFixed(2)}</td>
                        <td>${order.shares}</td>
                        <td>Rs. ${currentPrice.toFixed(2)} <span style="font-size: 0.85rem; color: var(--text-muted);">(${distance >= 0 ? '+' : ''}${distance.toFixed(1)}%)</span></td>
                        <td><span class="badge badge-info">ACTIVE</span></td>
                        <td style="font-size: 0.85rem;">${order.createdAt}</td>
                        <td><button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;" onclick="cancelLimitOrder(${order.id})">Cancel</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            if (executedOrders.length > 0) {
                html += '<h3 style="margin: 30px 0 15px; color: var(--text-muted);">‚úÖ Executed Orders</h3>';
                html += '<table><thead><tr>';
                html += '<th>Symbol</th><th>Type</th><th>Target Price</th><th>Executed Price</th><th>Shares</th><th>Executed At</th>';
                html += '</tr></thead><tbody>';
                
                executedOrders.slice(-10).reverse().forEach(order => {
                    html += `<tr>
                        <td><strong>${order.symbol}</strong></td>
                        <td><span style="color: ${order.type === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${order.type}</span></td>
                        <td>Rs. ${order.targetPrice.toFixed(2)}</td>
                        <td>Rs. ${order.executedPrice.toFixed(2)}</td>
                        <td>${order.shares}</td>
                        <td style="font-size: 0.85rem;">${order.executedAt}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            if (failedOrders.length > 0) {
                html += '<h3 style="margin: 30px 0 15px; color: var(--accent-red);">‚ùå Failed Orders</h3>';
                html += '<table><thead><tr>';
                html += '<th>Symbol</th><th>Type</th><th>Target Price</th><th>Shares</th><th>Reason</th><th>Action</th>';
                html += '</tr></thead><tbody>';
                
                failedOrders.forEach(order => {
                    html += `<tr>
                        <td><strong>${order.symbol}</strong></td>
                        <td><span style="color: ${order.type === 'BUY' ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${order.type}</span></td>
                        <td>Rs. ${order.targetPrice.toFixed(2)}</td>
                        <td>${order.shares}</td>
                        <td style="color: var(--accent-red);">${order.failReason}</td>
                        <td><button class="btn" style="padding: 6px 12px; font-size: 0.85rem;" onclick="deleteLimitOrder(${order.id})">Delete</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            }
            
            container.innerHTML = html;
        }

        function cancelLimitOrder(orderId) {
            const order = APP_STATE.limitOrders.find(o => o.id === orderId);
            if (!order) return;
            
            if (confirm(`Cancel limit order for ${order.shares} ${order.symbol} @ Rs. ${order.targetPrice.toFixed(2)}?`)) {
                APP_STATE.limitOrders = APP_STATE.limitOrders.filter(o => o.id !== orderId);
                showNotification('‚ùå Limit order cancelled');
                renderLimitOrdersPage();
            }
        }

        function deleteLimitOrder(orderId) {
            APP_STATE.limitOrders = APP_STATE.limitOrders.filter(o => o.id !== orderId);
            showNotification('üóëÔ∏è Order deleted');
            renderLimitOrdersPage();
        }

        // === WATCHLIST PAGE FUNCTIONS ===
        function renderWatchlistPage() {
            const container = document.getElementById('watchlistPageContent');
            
            if (APP_STATE.watchlists[0].stocks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üëÅÔ∏è</div>
                        <h3 style="color: var(--text-secondary); margin-bottom: 10px;">Your Watchlist is Empty</h3>
                        <p style="color: var(--text-muted); margin-bottom: 20px;">Add stocks you want to track</p>
                        <button class="btn btn-primary" onclick="openAddToWatchlistModal()">+ Add Your First Stock</button>
                    </div>
                `;
                return;
            }
            
            const watchedSymbols = APP_STATE.watchlists[0].stocks;
            const watchedStocks = STOCKS.filter(s => watchedSymbols.includes(s.symbol));
            
            let html = '<div class="dashboard-grid">';
            
            watchedStocks.forEach(stock => {
                html += `
                    <div class="stock-card" onclick="viewStock('${stock.symbol}')">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${stock.symbol}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${stock.name}</div>
                            </div>
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem;" onclick="event.stopPropagation(); removeFromWatchlist('${stock.symbol}')">
                                Remove
                            </button>
                        </div>
                        <div style="margin: 15px 0;">
                            <div style="font-size: 1.5rem; font-weight: bold;">Rs. ${stock.price.toFixed(2)}</div>
                            <div style="font-size: 0.9rem; color: ${stock.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600; margin-top: 5px;">
                                ${stock.change >= 0 ? '‚ñ≤' : '‚ñº'} ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                            <div>
                                <div>P/E Ratio</div>
                                <div style="color: var(--text-primary); font-weight: 600;">${stock.peRatio}</div>
                            </div>
                            <div>
                                <div>Mkt Cap</div>
                                <div style="color: var(--text-primary); font-weight: 600;">${stock.marketCap}</div>
                            </div>
                            <div>
                                <div>Dividend</div>
                                <div style="color: var(--text-primary); font-weight: 600;">${stock.dividend > 0 ? 'Rs.' + stock.dividend.toFixed(2) : 'N/A'}</div>
                            </div>
                            <div>
                                <div>1Y Return</div>
                                <div style="color: ${stock.yearReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                                    ${stock.yearReturn >= 0 ? '+' : ''}${stock.yearReturn.toFixed(1)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function openAddToWatchlistModal() {
            const modal = document.getElementById('addWatchlistModal');
            modal.classList.add('active');
            
            document.getElementById('watchlistSearchInput').value = '';
            filterWatchlistStocks();
        }

        function filterWatchlistStocks() {
            const searchTerm = document.getElementById('watchlistSearchInput').value.toLowerCase();
            const container = document.getElementById('watchlistStockOptions');
            const currentWatchlist = APP_STATE.watchlists[0].stocks;
            
            const filteredStocks = STOCKS.filter(s => {
                const matchesSearch = s.symbol.toLowerCase().includes(searchTerm) || 
                                     s.name.toLowerCase().includes(searchTerm);
                const notInWatchlist = !currentWatchlist.includes(s.symbol);
                return matchesSearch && notInWatchlist;
            });
            
            if (filteredStocks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No stocks found</p>';
                return;
            }
            
            let html = '';
            filteredStocks.forEach(stock => {
                html += `
                    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.3s; display: flex; justify-content: space-between; align-items: center;" 
                         onmouseover="this.style.background='var(--accent-blue)'" 
                         onmouseout="this.style.background='var(--bg-tertiary)'"
                         onclick="addStockToWatchlist('${stock.symbol}')">
                        <div>
                            <div style="font-weight: bold;">${stock.symbol}</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">${stock.name}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600;">Rs. ${stock.price.toFixed(2)}</div>
                            <div style="font-size: 0.85rem; color: ${stock.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">
                                ${stock.change >= 0 ? '+' : ''}${stock.changePercent.toFixed(2)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function addStockToWatchlist(symbol) {
            if (!APP_STATE.watchlists[0].stocks.includes(symbol)) {
                await fetch('/api/watchlist/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                APP_STATE.watchlists[0].stocks.push(symbol);
                showNotification(`‚úÖ ${symbol} added to watchlist`);
                closeModal('addWatchlistModal');
                if (APP_STATE.currentPage === 'watchlist') renderWatchlistPage();
                renderWatchlist();
            }
        }

        async function removeFromWatchlist(symbol) {
            if (confirm(`Remove ${symbol} from watchlist?`)) {
                await fetch('/api/watchlist/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                APP_STATE.watchlists[0].stocks = APP_STATE.watchlists[0].stocks.filter(s => s !== symbol);
                showNotification(`‚ùå ${symbol} removed from watchlist`);
                renderWatchlistPage();
                renderWatchlist();
            }
        }

        // === COMPARISON PAGE FUNCTIONS ===
        function initComparisonPage() {
            // Populate stock dropdowns
            const stockOptions = '<option value="">Select a stock</option>' + 
                STOCKS.map(s => `<option value="${s.symbol}">${s.symbol} - ${s.name}</option>`).join('');
            
            document.getElementById('compareStock1').innerHTML = stockOptions;
            document.getElementById('compareStock2').innerHTML = stockOptions;
            document.getElementById('compareStock3').innerHTML = stockOptions;
            document.getElementById('compareStock4').innerHTML = stockOptions;
            
            document.getElementById('comparisonResults').innerHTML = '';
        }

        function updateComparison() {
            // Auto-compare when selections change
            const stock1 = document.getElementById('compareStock1').value;
            const stock2 = document.getElementById('compareStock2').value;
            
            if (stock1 && stock2) {
                compareStocks();
            }
        }

        function compareStocks() {
            const selectedSymbols = [
                document.getElementById('compareStock1').value,
                document.getElementById('compareStock2').value,
                document.getElementById('compareStock3').value,
                document.getElementById('compareStock4').value
            ].filter(s => s !== '');
            
            if (selectedSymbols.length < 2) {
                showNotification('‚ùå Please select at least 2 stocks to compare', 'error');
                return;
            }
            
            const selectedStocks = selectedSymbols.map(sym => STOCKS.find(s => s.symbol === sym)).filter(s => s);
            
            const resultsContainer = document.getElementById('comparisonResults');
            
            let html = `
                <h3 style="margin: 30px 0 20px;">üìä Comparison Results</h3>
                
                <!-- Price Comparison -->
                <div class="card" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">üí∞ Price & Performance</h4>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    ${selectedStocks.map(s => `<th>${s.symbol}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Current Price</strong></td>
                                    ${selectedStocks.map(s => `<td>Rs. ${s.price.toFixed(2)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td><strong>Change Today</strong></td>
                                    ${selectedStocks.map(s => `
                                        <td style="color: ${s.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                                            ${s.change >= 0 ? '+' : ''}${s.change.toFixed(2)} (${s.changePercent.toFixed(2)}%)
                                        </td>
                                    `).join('')}
                                </tr>
                                <tr>
                                    <td><strong>1-Year Return</strong></td>
                                    ${selectedStocks.map(s => `
                                        <td style="color: ${s.yearReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">
                                            ${s.yearReturn >= 0 ? '+' : ''}${s.yearReturn.toFixed(1)}%
                                        </td>
                                    `).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Fundamentals Comparison -->
                <div class="card" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px;">üìà Fundamentals</h4>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    ${selectedStocks.map(s => `<th>${s.symbol}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Market Cap</strong></td>
                                    ${selectedStocks.map(s => `<td>${s.marketCap}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td><strong>P/E Ratio</strong></td>
                                    ${selectedStocks.map(s => {
                                        const pe = s.peRatio;
                                        const color = pe < 0 ? 'var(--accent-red)' : pe < 20 ? 'var(--accent-green)' : pe < 30 ? 'var(--text-primary)' : 'var(--accent-red)';
                                        return `<td style="color: ${color}; font-weight: 600;">${pe}</td>`;
                                    }).join('')}
                                </tr>
                                <tr>
                                    <td><strong>EPS</strong></td>
                                    ${selectedStocks.map(s => `<td>Rs. ${s.eps.toFixed(2)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td><strong>Book Value</strong></td>
                                    ${selectedStocks.map(s => `<td>${s.bookValue > 0 ? 'Rs.' + s.bookValue.toFixed(2) : 'N/A'}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td><strong>Dividend</strong></td>
                                    ${selectedStocks.map(s => `<td>${s.dividend > 0 ? 'Rs.' + s.dividend.toFixed(2) : 'None'}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Volume & Sector -->
                <div class="card">
                    <h4 style="margin-bottom: 15px;">üìä Additional Info</h4>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    ${selectedStocks.map(s => `<th>${s.symbol}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Sector</strong></td>
                                    ${selectedStocks.map(s => `<td>${s.sector}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td><strong>Volume</strong></td>
                                    ${selectedStocks.map(s => `<td>${(s.volume / 1000000).toFixed(1)}M</td>`).join('')}
                                </tr>
                                <tr>
                                    <td><strong>Company Name</strong></td>
                                    ${selectedStocks.map(s => `<td>${s.name}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Winner Analysis -->
                <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));">
                    <h4 style="margin-bottom: 15px;">üèÜ Quick Analysis</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        ${generateComparisonInsights(selectedStocks)}
                    </div>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
        }

        function generateComparisonInsights(stocks) {
            let insights = '';
            
            // Best Performer
            const bestPerformer = stocks.reduce((max, s) => s.yearReturn > max.yearReturn ? s : max);
            insights += `
                <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid var(--accent-green);">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px;">Best 1Y Performance</div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-green);">${bestPerformer.symbol}</div>
                    <div style="font-size: 0.9rem;">+${bestPerformer.yearReturn.toFixed(1)}% return</div>
                </div>
            `;
            
            // Lowest P/E
            const lowestPE = stocks.filter(s => s.peRatio > 0).reduce((min, s) => s.peRatio < min.peRatio ? s : min);
            if (lowestPE) {
                insights += `
                    <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid var(--accent-blue);">
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px;">Lowest P/E Ratio (Value)</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-blue);">${lowestPE.symbol}</div>
                        <div style="font-size: 0.9rem;">P/E: ${lowestPE.peRatio}</div>
                    </div>
                `;
            }
            
            // Highest Dividend
            const highestDiv = stocks.filter(s => s.dividend > 0).reduce((max, s) => s.dividend > max.dividend ? s : max, {dividend: 0});
            if (highestDiv.dividend > 0) {
                insights += `
                    <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid var(--accent-purple);">
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px;">Highest Dividend</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-purple);">${highestDiv.symbol}</div>
                        <div style="font-size: 0.9rem;">Rs. ${highestDiv.dividend.toFixed(2)} per share</div>
                    </div>
                `;
            }
            
            // Largest Market Cap
            const parseMarketCap = (cap) => {
                const num = parseFloat(cap);
                if (cap.includes('T')) return num * 1000;
                return num;
            };
            const largestCap = stocks.reduce((max, s) => parseMarketCap(s.marketCap) > parseMarketCap(max.marketCap) ? s : max);
            insights += `
                <div style="padding: 15px; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid var(--accent-green);">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px;">Largest Company</div>
                    <div style="font-size: 1.2rem; font-weight: bold;">${largestCap.symbol}</div>
                    <div style="font-size: 0.9rem;">Mkt Cap: ${largestCap.marketCap}</div>
                </div>
            `;
            
            return insights;
        }

        console.log('%cüöÄ Finaura Pro Ultimate Loaded!', 'color: #10b981; font-size: 20px; font-weight: bold;');
        
        // App is started by checkAuthThenInit() after login ‚Äî see auth overlay below
        // Force price update runs after startApp() boots the app
        
        console.log('%cAll 30+ features initialized. This is a demonstration version.', 'color: #3b82f6;');
    </script>
</body>
</html>
